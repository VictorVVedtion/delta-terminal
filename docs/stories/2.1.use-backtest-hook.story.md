# Story 2.1: useBacktest Hook 与回测状态管理

## Status

**Completed** ✅

---

## Story

**As a** 交易策略用户,
**I want** 回测执行过程有完整的状态管理和进度反馈,
**so that** 我可以实时了解回测进度并在完成后查看详细结果。

---

## Acceptance Criteria

1. [x] 创建 `hooks/useBacktest.ts` 主 Hook
2. [x] 实现回测状态机 (idle → configuring → running → completed/failed)
3. [x] 支持进度轮询机制
4. [x] 回测结果存储到本地状态
5. [x] 实现取消回测功能
6. [x] 错误处理与重试机制
7. [x] TypeScript 类型安全检查通过

---

## Tasks / Subtasks

- [ ] **Task 1: 定义回测状态类型** (AC: 2)
  - [ ] 定义 `BacktestPhase` 类型
  - [ ] 定义 `BacktestState` 接口
  - [ ] 定义 `UseBacktestOptions` 和 `UseBacktestReturn` 接口

- [ ] **Task 2: 实现 useBacktest 主 Hook** (AC: 1, 3, 4)
  - [ ] 初始化状态管理
  - [ ] 实现 `startBacktest` 方法
  - [ ] 实现进度轮询逻辑
  - [ ] 实现结果获取与存储

- [ ] **Task 3: 实现控制方法** (AC: 5, 6)
  - [ ] 实现 `pauseBacktest` 方法
  - [ ] 实现 `resumeBacktest` 方法
  - [ ] 实现 `cancelBacktest` 方法
  - [ ] 实现 `reset` 方法

- [ ] **Task 4: 错误处理** (AC: 6)
  - [ ] 定义 `BacktestError` 类
  - [ ] 实现错误恢复逻辑
  - [ ] 添加超时处理

- [ ] **Task 5: TypeScript 检查** (AC: 7)
  - [ ] 修复所有类型错误
  - [ ] 确保类型导出正确

---

## Dev Notes

### Hook 架构设计

参考 `useDeployment.ts` 模式：

```typescript
export type BacktestPhase =
  | 'idle'           // 初始状态
  | 'configuring'    // 配置中
  | 'running'        // 运行中
  | 'completed'      // 完成
  | 'failed'         // 失败

export interface BacktestState {
  phase: BacktestPhase
  progress: number
  currentStep: string
  error: BacktestError | null
  result: BacktestResult | null
}

export interface UseBacktestReturn {
  state: BacktestState
  config: BacktestConfig | null
  isRunning: boolean

  startBacktest: (config: BacktestConfig) => Promise<void>
  pauseBacktest: () => Promise<void>
  resumeBacktest: () => Promise<void>
  cancelBacktest: () => Promise<void>
  reset: () => void
}
```

### 进度更新策略

```typescript
// 轮询模式
useEffect(() => {
  if (!backtestId || state.phase !== 'running') return

  const poll = async () => {
    const status = await apiClient.getBacktestStatus(backtestId)
    setState(prev => ({
      ...prev,
      progress: status.progress,
      currentStep: status.stage
    }))

    if (status.status === 'completed') {
      const result = await apiClient.getBacktestResult(backtestId)
      setState(prev => ({ ...prev, phase: 'completed', result }))
    }
  }

  const interval = setInterval(poll, 2000)
  return () => clearInterval(interval)
}, [backtestId, state.phase])
```

### 文件路径

| 文件 | 路径 | 操作 |
|------|------|------|
| useBacktest Hook | `frontend/web-app/src/hooks/useBacktest.ts` | 新建 |
| backtest.ts 类型 | `frontend/web-app/src/types/backtest.ts` | 可能扩展 |

---

## Dependencies

- Story 2.2: 回测 API 接口 (可并行开发，使用 Mock)
- 现有: `types/backtest.ts` 类型定义

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | 初始 Story 创建 | YOLO Agent |

