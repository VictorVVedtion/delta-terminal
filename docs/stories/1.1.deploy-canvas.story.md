# Story 1.1: DeployCanvas éƒ¨ç½²ç¡®è®¤ç”»å¸ƒ

## Status

**Completed** âœ…

---

## Story

**As a** äº¤æ˜“ç­–ç•¥ç”¨æˆ·,
**I want** åœ¨å›æµ‹é€šè¿‡åçœ‹åˆ°æ¸…æ™°çš„éƒ¨ç½²ç¡®è®¤ç•Œé¢,
**so that** æˆ‘å¯ä»¥å®‰å…¨åœ°å°†ç­–ç•¥ä»å›æµ‹æ¨¡å¼éƒ¨ç½²åˆ° Paper æˆ– Live æ¨¡å¼ï¼Œå¹¶å®Œå…¨ç†è§£éƒ¨ç½²çš„å½±å“å’Œé£é™©ã€‚

---

## Acceptance Criteria

1. [x] åˆ›å»º `DeployCanvas.tsx` ç»„ä»¶ï¼Œéµå¾ªç°æœ‰ CanvasPanel æ»‘å‡ºé¢æ¿æ¨¡å¼
2. [x] æ”¯æŒ `mode: 'paper' | 'live'` ä¸¤ç§éƒ¨ç½²æ¨¡å¼åˆ‡æ¢
3. [x] Paper æ¨¡å¼æ˜¾ç¤ºï¼šå›æµ‹é€šè¿‡æ ‡è¯†ã€è™šæ‹Ÿèµ„é‡‘é…ç½® (é»˜è®¤ $10,000)ã€"éƒ¨ç½²æ¨¡æ‹Ÿç›˜" æŒ‰é’®
4. [x] Live æ¨¡å¼æ˜¾ç¤ºï¼šå‰ç½®æ¡ä»¶æ£€æŸ¥ (å›æµ‹ âœ“ + Paper 7å¤© âœ“)ã€åˆå§‹èµ„é‡‘é…ç½®ã€Paper æ”¶ç›Šå±•ç¤º
5. [x] Live æ¨¡å¼å®ç°åŒé‡ç¡®è®¤ï¼šâš ï¸ çœŸå®èµ„é‡‘è­¦å‘Š + â˜‘ï¸ checkbox ç¡®è®¤
6. [x] ç¡®è®¤ checkbox æœªå‹¾é€‰æ—¶ï¼Œéƒ¨ç½²æŒ‰é’®ä¿æŒç¦ç”¨çŠ¶æ€
7. [x] å¤ç”¨ RiverBit Design System æ ·å¼ (é¢œè‰²ã€é—´è·ã€åœ†è§’)
8. [x] ä¸ CanvasPanel æ»‘å‡ºäº¤äº’ä¸€è‡´ (å³ä¾§æ»‘å…¥ã€ESC å…³é—­ã€backdrop ç‚¹å‡»å…³é—­)

---

## Tasks / Subtasks

- [x] **Task 1: åˆ›å»º DeployCanvas ç»„ä»¶éª¨æ¶** (AC: 1, 8)
  - [x] åœ¨ `frontend/web-app/src/components/canvas/` åˆ›å»º `DeployCanvas.tsx`
  - [x] å¤åˆ¶ CanvasPanel çš„æ»‘å‡ºé¢æ¿ç»“æ„ (backdrop + aside)
  - [x] å®šä¹‰ `DeployCanvasProps` æ¥å£
  - [x] å®ç° ESC é”®å…³é—­å’Œ backdrop ç‚¹å‡»å…³é—­

- [x] **Task 2: å®ç° Paper éƒ¨ç½²æ¨¡å¼** (AC: 2, 3)
  - [x] åˆ›å»º `PaperDeployContent` å­ç»„ä»¶
  - [x] æ˜¾ç¤ºå›æµ‹é€šè¿‡æ ‡è¯† (ç»¿è‰² âœ“)
  - [x] æ·»åŠ è™šæ‹Ÿèµ„é‡‘é…ç½® (ä½¿ç”¨ ParamSliderï¼Œé»˜è®¤ $10,000ï¼ŒèŒƒå›´ $1,000-$100,000)
  - [x] å®ç° "éƒ¨ç½²æ¨¡æ‹Ÿç›˜" æŒ‰é’® (é»„è‰²/è­¦å‘Šè‰²)

- [x] **Task 3: å®ç° Live éƒ¨ç½²æ¨¡å¼** (AC: 2, 4)
  - [x] åˆ›å»º `LiveDeployContent` å­ç»„ä»¶
  - [x] æ˜¾ç¤ºå‰ç½®æ¡ä»¶æ£€æŸ¥åˆ—è¡¨ (å›æµ‹é€šè¿‡ âœ“, Paper è¿è¡Œæ—¶é—´ âœ“/âœ—)
  - [x] æ·»åŠ åˆå§‹èµ„é‡‘é…ç½® (ParamSlider)
  - [x] æ˜¾ç¤º Paper é˜¶æ®µæ”¶ç›Šç‡ (ç»¿è‰²/çº¢è‰²æ ¹æ®æ­£è´Ÿ)

- [x] **Task 4: å®ç°åŒé‡ç¡®è®¤æœºåˆ¶** (AC: 5, 6)
  - [x] åˆ›å»º `LiveConfirmationSection` å­ç»„ä»¶
  - [x] æ·»åŠ  âš ï¸ çœŸå®èµ„é‡‘è­¦å‘Šæ¡† (é»„è‰²èƒŒæ™¯)
  - [x] æ·»åŠ  checkbox "æˆ‘ç¡®è®¤ä½¿ç”¨çœŸå®èµ„é‡‘"
  - [x] å®ç°æŒ‰é’®ç¦ç”¨é€»è¾‘ (checkbox æœªå‹¾é€‰æ—¶ opacity: 0.5 + disabled)

- [x] **Task 5: æ ·å¼ä¸è®¾è®¡ç³»ç»Ÿå¯¹é½** (AC: 7)
  - [x] ä½¿ç”¨ RiverBit CSS å˜é‡ (`--rb-cyan`, `--rb-green`, `--rb-yellow`, `--rb-red`)
  - [x] å¤ç”¨ç°æœ‰ Badge ç»„ä»¶æ˜¾ç¤º Paper/Live æ¨¡å¼æ ‡è¯†
  - [x] ç¡®ä¿æ·±è‰²ä¸»é¢˜å…¼å®¹

- [x] **Task 6: å¯¼å‡ºå’Œé›†æˆå‡†å¤‡** (AC: 1)
  - [x] æ›´æ–° `components/canvas/index.ts` å¯¼å‡º DeployCanvas
  - [x] æ·»åŠ  `CanvasMode` ç±»å‹æ‰©å±• `'deploy'`
  - [x] åˆ›å»º `DeployCanvas.example.tsx` ç¤ºä¾‹æ–‡ä»¶

---

## Dev Notes

### ç°æœ‰ä»£ç æ¨¡å¼å‚è€ƒ

**CanvasPanel ç»„ä»¶ç»“æ„** [Source: components/canvas/CanvasPanel.tsx]:
```typescript
// Props æ¥å£æ¨¡å¼
interface CanvasPanelProps {
  insight: InsightData | null;
  isOpen: boolean;
  onClose?: (() => void) | undefined;
  onApprove?: ((insight: InsightData, params: InsightParam[]) => void) | undefined;
  onReject?: ((insight: InsightData) => void) | undefined;
  isLoading?: boolean | undefined;
}

// æ»‘å‡ºé¢æ¿ç»“æ„
<>
  {/* Backdrop for mobile */}
  <div className={cn(
    'fixed inset-0 bg-black/50 backdrop-blur-sm z-30 lg:hidden',
    isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'
  )} onClick={onClose} />

  {/* Sliding Panel */}
  <aside className={cn(
    'fixed top-0 right-0 z-40 h-full w-full sm:w-[520px]',
    'bg-card/80 backdrop-blur-sm border-l border-border shadow-2xl',
    'transform transition-transform duration-300 ease-out',
    isOpen ? 'translate-x-0' : 'translate-x-full'
  )}>
    <header>...</header>
    <div className="flex-1 overflow-y-auto">...</div>
    <footer>...</footer>
  </aside>
</>
```

**ESC é”®å…³é—­å®ç°** [Source: components/canvas/CanvasPanel.tsx:124-132]:
```typescript
React.useEffect(() => {
  const handleEscape = (e: KeyboardEvent) => {
    if (e.key === 'Escape' && isOpen) {
      onClose?.()
    }
  }
  window.addEventListener('keydown', handleEscape)
  return () => window.removeEventListener('keydown', handleEscape)
}, [isOpen, onClose])
```

### AgentStore çŠ¶æ€å®šä¹‰ [Source: store/agent.ts]

```typescript
export type AgentStatus = 'live' | 'paper' | 'shadow' | 'paused' | 'stopped'

export interface Agent {
  id: string;
  name: string;
  symbol: string;
  status: AgentStatus;
  pnl: number;
  pnlPercent: number;
  trades: number;
  winRate: number;
  createdAt: number;
  updatedAt: number;
}
```

### CanvasMode ç±»å‹æ‰©å±• [Source: types/insight.ts:236-242]

å½“å‰å®šä¹‰:
```typescript
export type CanvasMode =
  | 'proposal'
  | 'backtest'
  | 'explorer'
  | 'monitor'
  | 'config'
  | 'detail';
```

**éœ€è¦æ·»åŠ **: `'deploy'`

### DeployCanvas Props è®¾è®¡

```typescript
interface DeployCanvasProps {
  /** ç­–ç•¥ ID */
  strategyId: string;
  /** éƒ¨ç½²æ¨¡å¼ */
  mode: 'paper' | 'live';
  /** å›æµ‹ç»“æœæ‘˜è¦ */
  backtestResult: {
    passed: boolean;
    expectedReturn: number;
    maxDrawdown: number;
    winRate: number;
  };
  /** Paper è¿è¡Œæ•°æ® (Live æ¨¡å¼éœ€è¦) */
  paperPerformance?: {
    runningDays: number;
    requiredDays: number;  // é€šå¸¸ä¸º 7
    pnl: number;
    pnlPercent: number;
  };
  /** æ˜¯å¦æ‰“å¼€ */
  isOpen: boolean;
  /** éƒ¨ç½²å›è°ƒ */
  onDeploy: (config: DeployConfig) => Promise<void>;
  /** å–æ¶ˆå›è°ƒ */
  onCancel: () => void;
  /** åŠ è½½çŠ¶æ€ */
  isLoading?: boolean;
}

interface DeployConfig {
  mode: 'paper' | 'live';
  capital: number;
  confirmationToken?: string;  // Live æ¨¡å¼éœ€è¦
}
```

### RiverBit Design System é¢œè‰² [Source: styles/globals.css]

```css
--rb-cyan: #0EECBC;      /* ä¸»è‰² - æ€è€ƒä¸­/äº¤äº’ */
--rb-green: #61DD3C;     /* æˆåŠŸ - å›æµ‹é€šè¿‡/Live éƒ¨ç½² */
--rb-yellow: #E8BD30;    /* è­¦å‘Š - Paper æ¨¡å¼/ç¡®è®¤æç¤º */
--rb-red: #DD3C41;       /* å±é™© - é£é™©è­¦å‘Š */
```

### UI ç»„ä»¶ä¾èµ–

- `@/components/ui/button` - Button ç»„ä»¶
- `@/components/ui/badge` - Badge ç»„ä»¶ (Paper/Live æ ‡è¯†)
- `@/components/a2ui/controls/ParamSlider` - èµ„é‡‘é…ç½®æ»‘å—
- `@/components/ui/checkbox` - ç¡®è®¤å‹¾é€‰æ¡† (éœ€è¦ä» shadcn å®‰è£…)
- `lucide-react` å›¾æ ‡: Check, AlertTriangle, X, Rocket

### æ–‡ä»¶è·¯å¾„

| æ–‡ä»¶ | è·¯å¾„ |
|------|------|
| DeployCanvas ç»„ä»¶ | `frontend/web-app/src/components/canvas/DeployCanvas.tsx` |
| Canvas ç´¢å¼• | `frontend/web-app/src/components/canvas/index.ts` |
| ç±»å‹å®šä¹‰ | `frontend/web-app/src/types/insight.ts` |
| ç¤ºä¾‹æ–‡ä»¶ | `frontend/web-app/src/components/canvas/DeployCanvas.example.tsx` |

---

## Testing

### æµ‹è¯•æ–‡ä»¶ä½ç½®
`frontend/web-app/src/components/canvas/__tests__/DeployCanvas.test.tsx`

### æµ‹è¯•æ¡†æ¶
- Jest + React Testing Library
- @testing-library/user-event (ç”¨æˆ·äº¤äº’æ¨¡æ‹Ÿ)

### æµ‹è¯•ç”¨ä¾‹

1. **æ¸²æŸ“æµ‹è¯•**
   - æ­£ç¡®æ¸²æŸ“ Paper æ¨¡å¼å†…å®¹
   - æ­£ç¡®æ¸²æŸ“ Live æ¨¡å¼å†…å®¹
   - isOpen=false æ—¶é¢æ¿éšè—

2. **äº¤äº’æµ‹è¯•**
   - ESC é”®è§¦å‘ onCancel
   - backdrop ç‚¹å‡»è§¦å‘ onCancel
   - Paper æ¨¡å¼ç‚¹å‡»éƒ¨ç½²æŒ‰é’®è§¦å‘ onDeploy

3. **Live æ¨¡å¼åŒé‡ç¡®è®¤**
   - checkbox æœªå‹¾é€‰æ—¶æŒ‰é’®ç¦ç”¨
   - checkbox å‹¾é€‰åæŒ‰é’®å¯ç”¨
   - å‰ç½®æ¡ä»¶ä¸æ»¡è¶³æ—¶æ˜¾ç¤ºè­¦å‘Š

4. **æ— éšœç¢æµ‹è¯•**
   - role="dialog" å’Œ aria-modal="true"
   - æŒ‰é’®æœ‰æ­£ç¡®çš„ aria-label

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | åˆå§‹ Story åˆ›å»º | SM Bob |
| 2025-12-25 | 1.1 | å¼€å‘å®Œæˆï¼Œæäº¤ Ready for Review | Dev James |
| 2025-12-25 | 1.2 | QA å®¡æŸ¥é€šè¿‡ï¼Œæ·»åŠ æµ‹è¯•æ–‡ä»¶ï¼ŒçŠ¶æ€æ›´æ–°ä¸º Completed | QA Agent |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript errors fixed: unused imports (ChevronRight, TrendingDown, Clock), strategyId unused variable, exactOptionalPropertyTypes compatibility
- Canvas.tsx modeConfig: added 'deploy' mode with Rocket icon

### Completion Notes List
- Created DeployCanvas.tsx with ~500 lines, implementing Paper and Live deployment modes
- Implemented double confirmation mechanism for Live mode with real-fund warning and checkbox
- Added RiverBit Design System color variables for consistent styling
- Updated canvas/index.ts exports and types/insight.ts CanvasMode
- Installed shadcn checkbox component dependency
- Created DeployCanvas.example.tsx demo component

### File List
| File | Action | Description |
|------|--------|-------------|
| `frontend/web-app/src/components/canvas/DeployCanvas.tsx` | Created | Main deployment canvas component |
| `frontend/web-app/src/components/canvas/DeployCanvas.example.tsx` | Created | Demo/example usage component |
| `frontend/web-app/src/components/canvas/index.ts` | Modified | Added DeployCanvas exports |
| `frontend/web-app/src/components/canvas/Canvas.tsx` | Modified | Added 'deploy' to modeConfig |
| `frontend/web-app/src/types/insight.ts` | Modified | Added 'deploy' to CanvasMode |
| `frontend/web-app/src/components/ui/checkbox.tsx` | Created | Installed via shadcn |

---

## QA Results

**å®¡æŸ¥æ—¥æœŸ**: 2025-12-25
**å®¡æŸ¥äºº**: Claude QA Agent
**è¯„åˆ†**: 7.3/10 â†’ 9.5/10 (ä¿®å¤å)

### é€šè¿‡é¡¹
- âœ… 8/8 éªŒæ”¶æ ‡å‡†å…¨éƒ¨å®ç°
- âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—åŒ–è‰¯å¥½
- âœ… ç±»å‹å®‰å…¨ï¼ŒTypeScript é€šè¿‡
- âœ… RiverBit è®¾è®¡ç³»ç»Ÿå®Œå…¨ä¸€è‡´
- âœ… A11y å±æ€§å®Œæ•´
- âœ… æµ‹è¯•æ–‡ä»¶å·²æ·»åŠ 

### å·²ä¿®å¤é—®é¢˜
- âœ… æ·»åŠ äº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ `DeployCanvas.test.tsx`
- âœ… éªŒè¯ ParamSlider ä¾èµ–å­˜åœ¨

### é—ç•™å»ºè®® (éé˜»å¡)
- ğŸ’¡ è€ƒè™‘æ·»åŠ é”™è¯¯å¤„ç† try-catch
- ğŸ’¡ confirmationToken å¯æ”¹ç”¨ UUID
- ğŸ’¡ å‰ç½®æ¡ä»¶æœªæ»¡è¶³æ—¶å¯æ˜¾ç¤ºå…·ä½“åŸå› 

**ç»“è®º**: âœ… å¯ä»¥åˆå¹¶
