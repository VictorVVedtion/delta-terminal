# Story 3.1: useMonitor Hook 与监控状态管理

## Status

**Completed** ✅

---

## Story

**As a** 运行策略的用户,
**I want** 实时查看策略的运行状态、持仓和盈亏,
**so that** 我可以及时了解策略表现并做出调整决策。

---

## Acceptance Criteria

1. [ ] 创建 `hooks/useMonitor.ts` 主 Hook
2. [ ] 实现数据轮询机制 (默认 5 秒间隔)
3. [ ] 支持获取策略状态、持仓、交易记录
4. [ ] 实现暂停/恢复/停止策略方法
5. [ ] 错误处理与自动重连机制
6. [ ] 清理函数确保无内存泄漏
7. [ ] TypeScript 类型安全检查通过

---

## Tasks / Subtasks

- [ ] **Task 1: 定义监控状态类型** (AC: 1)
  - [ ] 定义 `MonitorState` 接口
  - [ ] 定义 `UseMonitorOptions` 和 `UseMonitorReturn` 接口
  - [ ] 复用 MonitorCanvas 已有类型

- [ ] **Task 2: 实现 useMonitor 主 Hook** (AC: 1, 2, 3)
  - [ ] 初始化状态管理
  - [ ] 实现数据获取逻辑
  - [ ] 实现轮询机制 (polling)
  - [ ] 实现数据刷新方法

- [ ] **Task 3: 实现控制方法** (AC: 4)
  - [ ] 实现 `pauseAgent` 方法
  - [ ] 实现 `resumeAgent` 方法
  - [ ] 实现 `stopAgent` 方法

- [ ] **Task 4: 错误处理与清理** (AC: 5, 6)
  - [ ] 实现错误处理逻辑
  - [ ] 实现自动重连机制
  - [ ] 实现组件卸载清理

- [ ] **Task 5: TypeScript 检查** (AC: 7)
  - [ ] 修复所有类型错误
  - [ ] 确保类型导出正确

---

## Dev Notes

### Hook 架构设计

参考 `useBacktest.ts` 模式：

```typescript
export interface MonitorState {
  strategy: StrategyInfo | null
  pnl: PnLData | null
  positions: Position[]
  recentTrades: Trade[]
  metrics: StrategyMetrics | null
  isLoading: boolean
  error: string | null
  lastUpdated: number | null
}

export interface UseMonitorOptions {
  agentId: string
  pollingInterval?: number // 默认 5000ms
  enabled?: boolean // 是否启用轮询
  onStatusChange?: (status: StrategyStatus) => void
  onError?: (error: Error) => void
}

export interface UseMonitorReturn {
  state: MonitorState
  isRunning: boolean
  isPaused: boolean

  pauseAgent: () => Promise<void>
  resumeAgent: () => Promise<void>
  stopAgent: () => Promise<void>
  refresh: () => Promise<void>
}
```

### 轮询策略

```typescript
useEffect(() => {
  if (!agentId || !enabled) return

  const fetchData = async () => {
    try {
      const [status, positions, trades, metrics] = await Promise.all([
        apiClient.getAgentStatus(agentId),
        apiClient.getAgentPositions(agentId),
        apiClient.getAgentTrades(agentId, 10),
        apiClient.getAgentMetrics(agentId),
      ])
      setState(prev => ({
        ...prev,
        strategy: status.strategy,
        pnl: status.pnl,
        positions,
        recentTrades: trades,
        metrics,
        lastUpdated: Date.now(),
        error: null,
      }))
    } catch (error) {
      handleError(error)
    }
  }

  fetchData() // 立即执行一次
  const interval = setInterval(fetchData, pollingInterval)
  return () => clearInterval(interval)
}, [agentId, enabled, pollingInterval])
```

### 文件路径

| 文件 | 路径 | 操作 |
|------|------|------|
| useMonitor Hook | `frontend/web-app/src/hooks/useMonitor.ts` | 新建 |

---

## Dependencies

- Story 3.2: 监控 API 接口 (可并行开发，使用 Mock)
- 现有: `components/canvas/MonitorCanvas.tsx` 类型定义

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | 初始 Story 创建 | YOLO Agent |

