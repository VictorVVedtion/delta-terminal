# Story 8.1: Hyperliquid 市场数据服务

## Story 信息

| 字段 | 值 |
|------|-----|
| Epic | EPIC-008: Paper Trading MVP |
| Story ID | 8.1 |
| 优先级 | 高 |
| 预估工时 | 2-3h |
| 状态 | 开发中 |

## 目标

建立与 Hyperliquid DEX 的数据连接，获取永续合约实时价格，为 Paper Trading 提供市场数据基础。

## 用户故事

> 作为一个 Paper Trading 用户，
> 我希望能够看到 Hyperliquid 的实时市场价格，
> 以便我的模拟交易能够基于真实市场数据进行。

## 验收标准

- [ ] AC1: 能够获取 BTC-PERP, ETH-PERP 实时 mid price
- [ ] AC2: 价格自动刷新，延迟 < 5 秒
- [ ] AC3: API 请求失败时显示友好错误提示
- [ ] AC4: 支持获取所有可用交易对列表
- [ ] AC5: 价格数据可在前端组件中使用

## 技术规格

### Hyperliquid API

```
Endpoint: https://api.hyperliquid.xyz/info
Method: POST
Content-Type: application/json

# 获取所有 Mid Prices
Request: { "type": "allMids" }
Response: { "BTC": "42150.5", "ETH": "2250.3", ... }

# 获取 Meta 信息（交易对列表）
Request: { "type": "meta" }
Response: { "universe": [...] }
```

### 文件结构

```
src/
├── lib/
│   └── hyperliquid.ts          # API 客户端
├── hooks/
│   └── useHyperliquidPrice.ts  # React Hook
└── types/
    └── hyperliquid.ts          # 类型定义
```

### 类型定义

```typescript
// types/hyperliquid.ts
export interface HyperliquidMidPrices {
  [symbol: string]: string  // symbol -> price string
}

export interface HyperliquidAsset {
  name: string
  szDecimals: number
  maxLeverage: number
}

export interface HyperliquidMeta {
  universe: HyperliquidAsset[]
}

export interface PriceData {
  symbol: string
  price: number
  timestamp: number
}
```

### API 客户端

```typescript
// lib/hyperliquid.ts
class HyperliquidClient {
  private baseUrl = 'https://api.hyperliquid.xyz/info'

  async getAllMidPrices(): Promise<HyperliquidMidPrices>
  async getPrice(symbol: string): Promise<number>
  async getMeta(): Promise<HyperliquidMeta>
}
```

### React Hook

```typescript
// hooks/useHyperliquidPrice.ts
function useHyperliquidPrice(symbols: string[], refreshInterval = 5000) {
  return {
    prices: Map<string, PriceData>,
    isLoading: boolean,
    error: Error | null,
    refresh: () => void
  }
}
```

## 实现任务

1. [x] 创建 Hyperliquid 类型定义
2. [x] 实现 Hyperliquid API 客户端
3. [x] 创建 useHyperliquidPrice Hook
4. [x] 添加错误处理和重试逻辑
5. [x] 集成测试

## 测试计划

### 单元测试
- API 客户端方法测试
- 价格解析测试
- 错误处理测试

### 集成测试
- 实际 API 调用测试
- Hook 渲染测试

## 依赖

- 无外部依赖（使用原生 fetch）

## 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| API 不稳定 | 中 | 添加重试和缓存 |
| 速率限制 | 低 | 控制刷新频率 |

---

**Created**: 2025-12-26
