# Story 4.2: 风险验证 Hook

## Status

**Completed** ✅

---

## Story

**As a** 系统,
**I want** 在部署前验证风险配置的合规性,
**so that** 防止用户部署高风险或配置错误的策略。

---

## Acceptance Criteria

1. [x] 创建 `hooks/useRiskValidation.ts`
2. [x] 验证止损必须设置 (Live 模式为错误)
3. [x] 验证止损百分比不能过大 (>10% 警告)
4. [x] 验证止损不能大于止盈
5. [x] 验证仓位限制在合理范围 (>50% 警告)
6. [x] 返回警告和错误列表
7. [x] 提供风险等级评估
8. [x] TypeScript 类型安全检查通过

---

## Tasks / Subtasks

- [ ] **Task 1: Hook 创建** (AC: 1)
  - [ ] 创建 `hooks/useRiskValidation.ts`
  - [ ] 定义验证结果接口
  - [ ] 实现主 Hook 函数

- [ ] **Task 2: 验证规则实现** (AC: 2, 3, 4, 5)
  - [ ] 实现止损必须验证
  - [ ] 实现止损百分比上限验证
  - [ ] 实现止损小于止盈验证
  - [ ] 实现仓位限制验证
  - [ ] 实现风险收益比验证

- [ ] **Task 3: 风险等级计算** (AC: 7)
  - [ ] 实现 calculateRiskLevel 函数
  - [ ] 考虑所有风险因素
  - [ ] 返回低/中/高风险评估

- [ ] **Task 4: 返回结果** (AC: 6)
  - [ ] 返回 errors 数组
  - [ ] 返回 warnings 数组
  - [ ] 返回 valid 布尔值
  - [ ] 返回 riskLevel

---

## Dev Notes

### 验证规则

| 规则 | 模式 | 类型 | 条件 |
|------|------|------|------|
| 止损必须设置 | Live | Error | !stopLoss.enabled |
| 止损过大 | All | Warning | stopLoss.value > 10% |
| 止损大于止盈 | All | Error | stopLoss.value >= takeProfit.value |
| 仓位过大 | All | Warning | positionLimit > 50% |
| 风险收益比过低 | All | Warning | ratio < 2 |

### Hook 接口

```typescript
interface RiskValidationOptions {
  settings: RiskSettings
  mode: 'paper' | 'live'
}

interface RiskValidationResult {
  valid: boolean
  errors: ValidationMessage[]
  warnings: ValidationMessage[]
  riskLevel: RiskLevel
  summary: {
    maxLoss: number
    maxGain: number
    riskRewardRatio: number
  }
}

interface ValidationMessage {
  field: string
  message: string
  code: string
}

function useRiskValidation(options: RiskValidationOptions): RiskValidationResult
```

### 验证逻辑

```typescript
function validateRiskSettings(
  settings: RiskSettings,
  mode: 'paper' | 'live'
): RiskValidationResult {
  const errors: ValidationMessage[] = []
  const warnings: ValidationMessage[] = []

  // Live 模式必须设置止损
  if (mode === 'live' && !settings.stopLoss.enabled) {
    errors.push({
      field: 'stopLoss.enabled',
      message: 'Live 模式必须设置止损',
      code: 'STOP_LOSS_REQUIRED',
    })
  }

  // 止损不能大于止盈
  if (
    settings.stopLoss.enabled &&
    settings.takeProfit.enabled &&
    settings.stopLoss.type === settings.takeProfit.type &&
    settings.stopLoss.value >= settings.takeProfit.value
  ) {
    errors.push({
      field: 'stopLoss.value',
      message: '止损必须小于止盈',
      code: 'STOP_LOSS_GREATER_THAN_TAKE_PROFIT',
    })
  }

  // 止损过大警告
  if (
    settings.stopLoss.enabled &&
    settings.stopLoss.type === 'percentage' &&
    settings.stopLoss.value > 10
  ) {
    warnings.push({
      field: 'stopLoss.value',
      message: '止损超过 10%，风险较高',
      code: 'STOP_LOSS_HIGH',
    })
  }

  // 仓位过大警告
  if (settings.positionLimit.maxPositionPercent > 50) {
    warnings.push({
      field: 'positionLimit.maxPositionPercent',
      message: '单策略仓位超过 50%，建议分散风险',
      code: 'POSITION_SIZE_HIGH',
    })
  }

  return {
    valid: errors.length === 0,
    errors,
    warnings,
    riskLevel: calculateRiskLevel(settings),
    summary: calculateSummary(settings),
  }
}
```

### 文件路径

| 文件 | 路径 | 操作 |
|------|------|------|
| useRiskValidation | `frontend/web-app/src/hooks/useRiskValidation.ts` | 创建 |

---

## Dependencies

- Story 4.1: 风险配置类型定义

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | 初始 Story 创建 | YOLO Agent |

