# Story 5.2: NotificationCenter 通知中心

## Status

**Completed** ✅

---

## Story

**As a** 用户,
**I want** 查看历史通知记录,
**so that** 我可以回顾重要事件和操作结果。

---

## Acceptance Criteria

1. [x] 创建 `store/notification.ts` 状态管理
2. [x] 创建 `components/NotificationCenter.tsx` 组件
3. [x] 通知按时间分组显示 (今天/昨天/更早)
4. [x] 支持标记单个通知已读
5. [x] 支持一键标记全部已读
6. [x] Header 显示未读通知数量徽章
7. [x] 通知中心可展开/收起
8. [x] TypeScript 类型安全检查通过

---

## Tasks / Subtasks

- [x] **Task 1: NotificationStore** (AC: 1)
  - [x] 创建 store 文件
  - [x] 定义 Notification 接口
  - [x] 实现 CRUD 操作
  - [x] 实现未读计数

- [x] **Task 2: NotificationCenter UI** (AC: 2, 3, 7)
  - [x] 创建组件文件
  - [x] 实现列表渲染
  - [x] 实现时间分组
  - [x] 实现展开/收起动画

- [x] **Task 3: 已读功能** (AC: 4, 5)
  - [x] 单个标记已读
  - [x] 全部标记已读
  - [x] 已读/未读样式区分

- [x] **Task 4: Header 集成** (AC: 6)
  - [x] 添加通知图标按钮
  - [x] 显示未读数量徽章
  - [x] 点击展开通知中心

---

## Dev Notes

### NotificationStore 接口

```typescript
// store/notification.ts
import { create } from 'zustand'
import { persist } from 'zustand/middleware'

export interface Notification {
  id: string
  type: 'success' | 'error' | 'warning' | 'info'
  title: string
  description?: string
  timestamp: number
  read: boolean
  source?: string
}

interface NotificationState {
  notifications: Notification[]

  addNotification: (notification: Omit<Notification, 'id' | 'timestamp' | 'read'>) => void
  markAsRead: (id: string) => void
  markAllAsRead: () => void
  removeNotification: (id: string) => void
  clearAll: () => void

  // Computed
  getUnreadCount: () => number
}

export const useNotificationStore = create<NotificationState>()(
  persist(
    (set, get) => ({
      notifications: [],

      addNotification: (notification) =>
        set((state) => ({
          notifications: [
            {
              ...notification,
              id: `notif_${Date.now()}`,
              timestamp: Date.now(),
              read: false,
            },
            ...state.notifications,
          ].slice(0, 50), // 最多保留 50 条
        })),

      markAsRead: (id) =>
        set((state) => ({
          notifications: state.notifications.map((n) =>
            n.id === id ? { ...n, read: true } : n
          ),
        })),

      markAllAsRead: () =>
        set((state) => ({
          notifications: state.notifications.map((n) => ({ ...n, read: true })),
        })),

      removeNotification: (id) =>
        set((state) => ({
          notifications: state.notifications.filter((n) => n.id !== id),
        })),

      clearAll: () => set({ notifications: [] }),

      getUnreadCount: () => get().notifications.filter((n) => !n.read).length,
    }),
    {
      name: 'delta-notifications',
    }
  )
)
```

### 时间分组逻辑

```typescript
function groupByDate(notifications: Notification[]) {
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  const yesterday = new Date(today)
  yesterday.setDate(yesterday.getDate() - 1)

  return {
    today: notifications.filter((n) => n.timestamp >= today.getTime()),
    yesterday: notifications.filter(
      (n) => n.timestamp >= yesterday.getTime() && n.timestamp < today.getTime()
    ),
    earlier: notifications.filter((n) => n.timestamp < yesterday.getTime()),
  }
}
```

### UI 结构

```tsx
<Popover>
  <PopoverTrigger>
    <Button variant="ghost" size="icon">
      <Bell className="h-5 w-5" />
      {unreadCount > 0 && (
        <Badge className="absolute -top-1 -right-1">{unreadCount}</Badge>
      )}
    </Button>
  </PopoverTrigger>
  <PopoverContent className="w-80 p-0">
    <NotificationList />
  </PopoverContent>
</Popover>
```

---

## Dependencies

- Story 5.1: Toast 组件

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | 初始 Story 创建 | YOLO Agent |
