# Story 8.2: 虚拟账户与模拟订单系统

## Story 信息

| 字段 | 值 |
|------|-----|
| Epic | EPIC-008: Paper Trading MVP |
| Story ID | 8.2 |
| 优先级 | 高 |
| 预估工时 | 3-4h |
| 状态 | 开发中 |

## 目标

实现虚拟资金管理和模拟订单执行系统，让用户能够使用虚拟资金进行模拟交易。

## 用户故事

> 作为一个 Paper Trading 用户，
> 我希望能够使用虚拟资金执行买入/卖出操作，
> 以便验证我的交易策略而不承担真实资金风险。

## 验收标准

- [ ] AC1: 从 DeployCanvas 启动后能初始化虚拟账户
- [ ] AC2: 支持模拟市价单买入/卖出
- [ ] AC3: 持仓数据实时更新（数量、入场价）
- [ ] AC4: 未实现盈亏根据实时价格动态计算
- [ ] AC5: 账户状态持久化（刷新页面不丢失）
- [ ] AC6: 支持平仓操作

## 技术规格

### 文件结构

```
src/
├── store/
│   └── paperTrading.ts         # Zustand Store
├── hooks/
│   └── usePaperTrading.ts      # React Hook
└── types/
    └── paperTrading.ts         # 类型定义
```

### 类型定义

```typescript
// types/paperTrading.ts

export interface PaperAccount {
  id: string
  agentId: string
  initialCapital: number      // 初始资金
  currentBalance: number      // 可用余额
  positions: PaperPosition[]  // 持仓列表
  trades: PaperTrade[]        // 交易历史
  createdAt: number
  updatedAt: number
}

export interface PaperPosition {
  id: string
  symbol: string              // 如 "BTC"
  side: 'long' | 'short'      // 多/空
  size: number                // 持仓数量
  entryPrice: number          // 入场均价
  currentPrice: number        // 当前价格
  unrealizedPnl: number       // 未实现盈亏
  unrealizedPnlPercent: number // 盈亏百分比
  margin: number              // 占用保证金
  openedAt: number            // 开仓时间
}

export interface PaperTrade {
  id: string
  symbol: string
  side: 'buy' | 'sell'
  type: 'open' | 'close'      // 开仓/平仓
  size: number
  price: number
  fee: number                 // 手续费 (0.1%)
  pnl?: number                // 平仓时的实现盈亏
  timestamp: number
}

export interface PaperOrderRequest {
  symbol: string
  side: 'buy' | 'sell'
  size: number                // USDT 金额或数量
  sizeType: 'quote' | 'base'  // 按金额还是按数量
}
```

### Zustand Store

```typescript
// store/paperTrading.ts

interface PaperTradingState {
  // State
  account: PaperAccount | null
  isInitialized: boolean

  // Actions
  initializeAccount: (agentId: string, capital: number) => void
  executeOrder: (order: PaperOrderRequest, currentPrice: number) => boolean
  closePosition: (positionId: string, currentPrice: number) => boolean
  updatePrices: (prices: Map<string, number>) => void
  getAccountSummary: () => AccountSummary
  reset: () => void
}

interface AccountSummary {
  totalEquity: number         // 总权益
  availableBalance: number    // 可用余额
  totalUnrealizedPnl: number  // 总未实现盈亏
  totalRealizedPnl: number    // 总已实现盈亏
  marginUsed: number          // 已用保证金
  positionCount: number       // 持仓数量
}
```

### React Hook

```typescript
// hooks/usePaperTrading.ts

function usePaperTrading() {
  return {
    // State
    account: PaperAccount | null,
    positions: PaperPosition[],
    trades: PaperTrade[],
    summary: AccountSummary,

    // Actions
    initialize: (agentId: string, capital: number) => void,
    buy: (symbol: string, amount: number) => boolean,
    sell: (symbol: string, amount: number) => boolean,
    closePosition: (positionId: string) => boolean,
    closeAllPositions: () => void,

    // Status
    isInitialized: boolean,
    hasOpenPositions: boolean,
  }
}
```

## 业务逻辑

### 订单执行流程

```
1. 用户提交订单
2. 检查可用余额是否足够
3. 计算订单金额和手续费
4. 扣除余额
5. 创建/更新持仓
6. 记录交易历史
7. 触发 UI 更新
```

### 盈亏计算

```typescript
// 未实现盈亏
unrealizedPnl = (currentPrice - entryPrice) * size * (side === 'long' ? 1 : -1)

// 盈亏百分比
unrealizedPnlPercent = unrealizedPnl / (entryPrice * size) * 100

// 手续费 (Hyperliquid taker fee)
fee = orderValue * 0.001  // 0.1%
```

### 持仓合并逻辑

```typescript
// 同方向加仓：计算新均价
newEntryPrice = (oldSize * oldEntry + newSize * newPrice) / (oldSize + newSize)
newSize = oldSize + newSize

// 反方向减仓：实现盈亏
if (newSize <= oldSize) {
  realizedPnl = (closePrice - entryPrice) * closeSize * direction
  remainingSize = oldSize - newSize
}
```

## 实现任务

1. [x] 创建 Paper Trading 类型定义
2. [x] 实现 Zustand Store
3. [x] 创建 usePaperTrading Hook
4. [x] 添加持久化 (persist middleware)
5. [x] 集成价格更新
6. [x] 与 DeployCanvas 集成

## 测试计划

### 单元测试
- 订单执行逻辑
- 盈亏计算准确性
- 持仓合并逻辑

### 集成测试
- 完整交易流程
- 状态持久化
- 价格更新

## 依赖

- Story 8.1: Hyperliquid 市场数据（用于实时价格）

## 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 计算精度问题 | 中 | 使用固定小数位 |
| 状态不一致 | 低 | 原子操作更新 |

---

**Created**: 2025-12-26
