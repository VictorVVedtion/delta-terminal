# Story 2.2: 回测 API 接口与数据层

## Status

**Completed** ✅

---

## Story

**As a** 前端开发者,
**I want** 完整的回测 API 接口和状态管理层,
**so that** useBacktest Hook 可以正确调用回测服务并管理回测历史。

---

## Acceptance Criteria

1. [x] `lib/api.ts` 新增 `runBacktest()` 方法
2. [x] `lib/api.ts` 新增 `getBacktestStatus()` 方法
3. [x] `lib/api.ts` 新增 `cancelBacktest()` 方法
4. [x] `lib/api.ts` 新增 `getBacktestResult()` 方法
5. [x] 创建 `store/backtest.ts` Zustand Store
6. [x] Mock 数据支持开发测试
7. [x] TypeScript 类型完整

---

## Tasks / Subtasks

- [ ] **Task 1: API 客户端扩展** (AC: 1-4)
  - [ ] 添加 `runBacktest(config)` 方法
  - [ ] 添加 `getBacktestStatus(backtestId)` 方法
  - [ ] 添加 `cancelBacktest(backtestId)` 方法
  - [ ] 添加 `getBacktestResult(backtestId)` 方法
  - [ ] 添加 `getBacktestHistory(strategyId)` 方法

- [ ] **Task 2: Mock 数据实现** (AC: 6)
  - [ ] 在 `lib/api.mock.ts` 添加回测 Mock
  - [ ] 模拟进度更新序列
  - [ ] 模拟完整回测结果
  - [ ] 模拟失败场景

- [ ] **Task 3: BacktestStore 创建** (AC: 5)
  - [ ] 创建 `store/backtest.ts`
  - [ ] 实现回测历史管理
  - [ ] 实现当前回测状态管理
  - [ ] 实现结果缓存

- [ ] **Task 4: 类型定义补充** (AC: 7)
  - [ ] 确保 API 返回类型完整
  - [ ] 添加缺失的状态类型

---

## Dev Notes

### API 设计

```typescript
// lib/api.ts 扩展

interface ApiClient {
  // 回测相关
  runBacktest(config: BacktestConfig): Promise<{ backtestId: string }>
  getBacktestStatus(backtestId: string): Promise<BacktestRunState>
  cancelBacktest(backtestId: string): Promise<void>
  getBacktestResult(backtestId: string): Promise<BacktestResult>
  getBacktestHistory(strategyId: string): Promise<BacktestHistoryItem[]>
}
```

### Mock 数据设计

```typescript
// lib/api.mock.ts

const mockBacktestProgress = [
  { progress: 10, stage: 'preparing' },
  { progress: 25, stage: 'loading_data' },
  { progress: 50, stage: 'running' },
  { progress: 75, stage: 'running' },
  { progress: 90, stage: 'analyzing' },
  { progress: 100, stage: 'completed' },
]

const mockBacktestResult: BacktestResult = {
  id: 'bt-001',
  config: { ... },
  metrics: {
    totalReturn: 23.45,
    annualizedReturn: 156.8,
    maxDrawdown: -12.3,
    sharpeRatio: 1.85,
    winRate: 62.5,
    totalTrades: 48,
    profitFactor: 1.92,
    avgWin: 3.2,
    avgLoss: -1.8,
  },
  equity: [...],
  trades: [...],
  createdAt: new Date().toISOString(),
  completedAt: new Date().toISOString(),
}
```

### BacktestStore 设计

```typescript
// store/backtest.ts

interface BacktestStoreState {
  // 当前回测
  currentBacktestId: string | null
  currentConfig: BacktestConfig | null
  currentStatus: BacktestRunState
  currentResult: BacktestResult | null

  // 历史
  history: BacktestHistoryItem[]

  // Actions
  setCurrentBacktest: (id: string, config: BacktestConfig) => void
  updateStatus: (status: BacktestRunState) => void
  setResult: (result: BacktestResult) => void
  clearCurrent: () => void
  addToHistory: (item: BacktestHistoryItem) => void
}
```

### 文件路径

| 文件 | 路径 | 操作 |
|------|------|------|
| API 客户端 | `frontend/web-app/src/lib/api.ts` | 扩展 |
| Mock 数据 | `frontend/web-app/src/lib/api.mock.ts` | 扩展 |
| BacktestStore | `frontend/web-app/src/store/backtest.ts` | 新建 |

---

## Dependencies

- 现有: `types/backtest.ts` 类型定义
- 现有: `lib/api.ts` API 客户端结构

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | 初始 Story 创建 | YOLO Agent |

