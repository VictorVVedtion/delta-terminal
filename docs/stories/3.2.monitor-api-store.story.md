# Story 3.2: 监控 API 接口与数据层

## Status

**Completed** ✅

---

## Story

**As a** 前端开发者,
**I want** 完整的监控 API 接口和状态管理层,
**so that** useMonitor Hook 可以正确调用后端服务并管理监控数据。

---

## Acceptance Criteria

1. [ ] `lib/api.ts` 新增 `getAgentStatus()` 方法
2. [ ] `lib/api.ts` 新增 `getAgentPositions()` 方法
3. [ ] `lib/api.ts` 新增 `getAgentTrades()` 方法
4. [ ] `lib/api.ts` 新增 `getAgentMetrics()` 方法
5. [ ] `lib/api.ts` 新增 `pauseAgent()`, `resumeAgent()`, `stopAgent()` 方法
6. [ ] 创建 `store/monitor.ts` Zustand Store
7. [ ] Mock 数据支持开发测试
8. [ ] TypeScript 类型完整

---

## Tasks / Subtasks

- [ ] **Task 1: API 客户端扩展** (AC: 1-5)
  - [ ] 添加 `getAgentStatus(agentId)` 方法
  - [ ] 添加 `getAgentPositions(agentId)` 方法
  - [ ] 添加 `getAgentTrades(agentId, limit?)` 方法
  - [ ] 添加 `getAgentMetrics(agentId)` 方法
  - [ ] 添加 `pauseAgent(agentId)` 方法
  - [ ] 添加 `resumeAgent(agentId)` 方法
  - [ ] 添加 `stopAgent(agentId)` 方法

- [ ] **Task 2: Mock 数据实现** (AC: 7)
  - [ ] 在 `lib/api.mock.ts` 添加监控 Mock
  - [ ] 模拟实时持仓数据
  - [ ] 模拟交易记录
  - [ ] 模拟性能指标

- [ ] **Task 3: MonitorStore 创建** (AC: 6)
  - [ ] 创建 `store/monitor.ts`
  - [ ] 实现当前监控 Agent 管理
  - [ ] 实现监控数据缓存
  - [ ] 与 AgentStore 联动

- [ ] **Task 4: 类型定义补充** (AC: 8)
  - [ ] 确保 API 返回类型完整
  - [ ] 复用 MonitorCanvas 已有类型

---

## Dev Notes

### API 设计

```typescript
// lib/api.ts 扩展

interface AgentStatus {
  strategy: StrategyInfo
  pnl: PnLData
}

// 获取 Agent 状态
async getAgentStatus(agentId: string): Promise<AgentStatus>

// 获取持仓
async getAgentPositions(agentId: string): Promise<Position[]>

// 获取交易记录
async getAgentTrades(agentId: string, limit?: number): Promise<Trade[]>

// 获取性能指标
async getAgentMetrics(agentId: string): Promise<StrategyMetrics>

// 暂停 Agent
async pauseAgent(agentId: string): Promise<{ success: boolean }>

// 恢复 Agent
async resumeAgent(agentId: string): Promise<{ success: boolean }>

// 停止 Agent
async stopAgent(agentId: string): Promise<{ success: boolean }>
```

### Mock 数据设计

```typescript
// lib/api.mock.ts

const mockStrategyInfo: StrategyInfo = {
  name: 'BTC 网格策略',
  symbol: 'BTC/USDT',
  status: 'running',
  createdAt: new Date().toISOString(),
}

const mockPnLData: PnLData = {
  daily: 125.50,
  total: 1250.80,
  unrealized: 85.20,
  realized: 1165.60,
}

const mockPositions: Position[] = [
  {
    symbol: 'BTC',
    amount: 0.05,
    avgPrice: 42000,
    currentPrice: 43500,
    unrealizedPnl: 75,
    unrealizedPnlPercent: 3.57,
  },
]

const mockTrades: Trade[] = [
  {
    id: 'trade_001',
    timestamp: Date.now() - 3600000,
    symbol: 'BTC/USDT',
    side: 'buy',
    price: 42000,
    amount: 0.02,
    fee: 0.84,
    realizedPnl: 0,
  },
]

const mockMetrics: StrategyMetrics = {
  winRate: 0.65,
  avgHoldTime: '4.2h',
  maxDrawdown: 8.5,
  totalTrades: 28,
  winningTrades: 18,
  losingTrades: 10,
}
```

### MonitorStore 设计

```typescript
// store/monitor.ts

interface MonitorStoreState {
  // 当前监控的 Agent
  currentAgentId: string | null

  // 缓存的监控数据
  cachedData: Map<string, MonitorData>

  // 最后更新时间
  lastUpdated: Map<string, number>

  // Actions
  setCurrentAgent: (agentId: string) => void
  updateData: (agentId: string, data: MonitorData) => void
  clearCurrent: () => void
}
```

### 文件路径

| 文件 | 路径 | 操作 |
|------|------|------|
| API 客户端 | `frontend/web-app/src/lib/api.ts` | 扩展 |
| Mock 数据 | `frontend/web-app/src/lib/api.mock.ts` | 扩展 |
| MonitorStore | `frontend/web-app/src/store/monitor.ts` | 新建 |

---

## Dependencies

- 现有: `components/canvas/MonitorCanvas.tsx` 类型定义
- 现有: `lib/api.ts` API 客户端结构
- 现有: `store/agent.ts` Agent 状态管理

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | 初始 Story 创建 | YOLO Agent |

