# Story 5.3: 通知系统集成

## Status

**Completed** ✅

---

## Story

**As a** 用户,
**I want** 在执行关键操作后自动收到通知,
**so that** 我无需手动刷新就能了解操作结果。

---

## Acceptance Criteria

1. [x] KillSwitch 执行后显示成功/失败 Toast
2. [x] DeployCanvas 部署成功/失败 Toast
3. [x] BacktestCanvas 回测完成 Toast
4. [x] MonitorCanvas 策略状态变化 Toast
5. [x] 所有 Toast 同时记录到 NotificationStore
6. [x] 通知包含操作详情和时间戳
7. [x] TypeScript 类型安全检查通过

---

## Tasks / Subtasks

- [x] **Task 1: KillSwitch 集成** (AC: 1, 5)
  - [x] 导入 toast 和 notification store
  - [x] 成功后显示 toast.success
  - [x] 失败后显示 toast.error
  - [x] 记录到 notification store

- [x] **Task 2: DeployCanvas 集成** (AC: 2, 5, 6)
  - [x] 部署成功显示 toast.success
  - [x] 部署失败显示 toast.error
  - [x] 包含策略名称和模式信息

- [x] **Task 3: BacktestCanvas 集成** (AC: 3, 5, 6)
  - [x] 回测完成显示 toast.success
  - [x] 包含收益率信息

- [x] **Task 4: MonitorCanvas 集成** (AC: 4, 5, 6)
  - [x] 策略暂停显示 toast.warning
  - [x] 策略停止显示 toast.info
  - [x] 策略恢复显示 toast.success

---

## Dev Notes

### 通知帮助函数

```typescript
// lib/notification.ts
import { toast } from './toast'
import { useNotificationStore } from '@/store/notification'

export function notify(
  type: 'success' | 'error' | 'warning' | 'info',
  title: string,
  options?: {
    description?: string
    source?: string
    action?: {
      label: string
      onClick: () => void
    }
  }
) {
  // 显示 Toast
  toast[type](title, {
    description: options?.description,
    action: options?.action,
  })

  // 记录到 Store
  useNotificationStore.getState().addNotification({
    type,
    title,
    description: options?.description,
    source: options?.source,
  })
}
```

### 集成示例

```typescript
// KillSwitch.tsx
import { notify } from '@/lib/notification'

const handleEmergencyStop = async () => {
  try {
    // ... 执行操作
    notify('success', '紧急停止已执行', {
      description: `已取消 ${cancelledOrders} 个挂单，平仓 ${closedPositions} 个持仓`,
      source: 'KillSwitch',
    })
  } catch (error) {
    notify('error', '紧急停止执行失败', {
      description: '请手动检查账户状态',
      source: 'KillSwitch',
      action: {
        label: '重试',
        onClick: handleEmergencyStop,
      },
    })
  }
}
```

```typescript
// DeployCanvas 部署成功
notify('success', '部署成功', {
  description: `${strategyName} 已部署到 ${mode === 'live' ? '实盘' : '模拟盘'}`,
  source: 'DeployCanvas',
})
```

```typescript
// BacktestCanvas 回测完成
notify('success', '回测完成', {
  description: `收益率 ${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(1)}%`,
  source: 'BacktestCanvas',
})
```

```typescript
// MonitorCanvas 策略暂停
notify('warning', '策略已暂停', {
  description: `${strategyName} 已暂停运行`,
  source: 'MonitorCanvas',
})
```

---

## 文件修改清单

| 文件 | 路径 | 修改 |
|------|------|------|
| notification helper | `lib/notification.ts` | 创建 |
| KillSwitch | `components/KillSwitch.tsx` | 添加通知 |
| DeployCanvas | `components/canvas/DeployCanvas.tsx` | 在回调中添加通知 |
| BacktestCanvas | `components/canvas/BacktestCanvas.tsx` | 在回调中添加通知 |
| MonitorCanvas | `components/canvas/MonitorCanvas.tsx` | 在回调中添加通知 |

---

## Dependencies

- Story 5.1: Toast 组件
- Story 5.2: NotificationCenter 组件

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | 初始 Story 创建 | YOLO Agent |
