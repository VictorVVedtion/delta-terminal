# Story 4.3: DeployCanvas 风险管理集成

## Status

**Completed** ✅

---

## Story

**As a** 交易策略用户,
**I want** 在部署界面中直接配置和验证风险设置,
**so that** 我可以一站式完成策略部署和风险配置。

---

## Acceptance Criteria

1. [x] 扩展 DeployConfig 包含 riskSettings 字段
2. [x] DeployCanvas 渲染 RiskSettings 组件
3. [x] 部署按钮点击前运行风险验证
4. [x] 验证失败时阻止部署并显示错误
5. [x] 显示风险验证警告信息
6. [ ] 更新 API 层传递风险配置 (待后端集成)
7. [ ] AgentStore 保存风险设置 (待后端集成)
8. [x] TypeScript 类型安全检查通过

---

## Tasks / Subtasks

- [ ] **Task 1: 类型扩展** (AC: 1)
  - [ ] 扩展 DeployConfig 接口
  - [ ] 更新相关类型引用

- [ ] **Task 2: UI 集成** (AC: 2)
  - [ ] 导入 RiskSettings 组件
  - [ ] 在 DeployCanvas 中渲染
  - [ ] 添加状态管理

- [ ] **Task 3: 验证集成** (AC: 3, 4, 5)
  - [ ] 使用 useRiskValidation Hook
  - [ ] 部署前触发验证
  - [ ] 显示验证错误
  - [ ] 显示验证警告
  - [ ] 错误时禁用部署按钮

- [ ] **Task 4: API/Store 更新** (AC: 6, 7)
  - [ ] 更新 deployAgent API 参数
  - [ ] 更新 AgentStore 保存风险设置
  - [ ] Mock 数据支持

- [ ] **Task 5: TypeScript 检查** (AC: 8)
  - [ ] 修复所有类型错误
  - [ ] 确保接口正确

---

## Dev Notes

### DeployConfig 扩展

```typescript
// 扩展后
export interface DeployConfig {
  mode: 'paper' | 'live'
  capital: number
  confirmationToken?: string
  riskSettings: RiskSettings  // 新增
}
```

### DeployCanvas 集成

```tsx
// DeployCanvas.tsx 修改

import { RiskSettings as RiskSettingsType, DEFAULT_RISK_SETTINGS } from '@/types/risk'
import { RiskSettings } from './RiskSettings'
import { useRiskValidation } from '@/hooks/useRiskValidation'

// 状态
const [riskSettings, setRiskSettings] = useState<RiskSettingsType>(DEFAULT_RISK_SETTINGS)

// 验证
const { valid, errors, warnings, riskLevel } = useRiskValidation({
  settings: riskSettings,
  mode: mode,
})

// 部署前检查
const handleDeploy = async () => {
  if (!valid) {
    // 显示错误
    return
  }

  await onDeploy({
    mode,
    capital,
    riskSettings,
  })
}

// 渲染
<RiskSettings
  value={riskSettings}
  onChange={setRiskSettings}
  currentPrice={currentPrice}
  totalCapital={capital}
/>

{/* 验证消息 */}
{errors.length > 0 && (
  <div className="text-red-500">
    {errors.map(e => <p key={e.code}>{e.message}</p>)}
  </div>
)}

{warnings.length > 0 && (
  <div className="text-yellow-500">
    {warnings.map(w => <p key={w.code}>{w.message}</p>)}
  </div>
)}
```

### API 更新

```typescript
// lib/api.ts 修改

async deployAgent(
  strategyId: string,
  config: DeployConfig
): Promise<DeployResult> {
  // config 现在包含 riskSettings
  return this.request('/agents/deploy', {
    method: 'POST',
    body: {
      strategy_id: strategyId,
      mode: config.mode,
      capital: config.capital,
      risk_settings: {
        stop_loss: config.riskSettings.stopLoss,
        take_profit: config.riskSettings.takeProfit,
        position_limit: config.riskSettings.positionLimit,
      },
    },
  })
}
```

### 文件路径

| 文件 | 路径 | 操作 |
|------|------|------|
| DeployCanvas | `frontend/web-app/src/components/canvas/DeployCanvas.tsx` | 修改 |
| api.ts | `frontend/web-app/src/lib/api.ts` | 修改 |
| api.mock.ts | `frontend/web-app/src/lib/api.mock.ts` | 修改 |

---

## Dependencies

- Story 4.1: RiskSettings 组件
- Story 4.2: useRiskValidation Hook

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | 初始 Story 创建 | YOLO Agent |

