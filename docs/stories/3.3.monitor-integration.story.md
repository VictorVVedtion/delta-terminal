# Story 3.3: ChatInterface ç›‘æ§æµç¨‹é›†æˆ

## Status

**Completed** âœ…

---

## Story

**As a** äº¤æ˜“ç­–ç•¥ç”¨æˆ·,
**I want** åœ¨å¯¹è¯ç•Œé¢ä¸­å¯ä»¥å¿«é€ŸæŸ¥çœ‹å’Œæ§åˆ¶è¿è¡Œä¸­çš„ç­–ç•¥,
**so that** æˆ‘å¯ä»¥æ— ç¼åœ°ç›‘æ§ç­–ç•¥è¡¨ç°å¹¶åœ¨éœ€è¦æ—¶æš‚åœæˆ–åœæ­¢ã€‚

---

## Acceptance Criteria

1. [ ] ChatInterface æ£€æµ‹ `stop_agent` action
2. [ ] æ”¯æŒç”¨æˆ·ä¸»åŠ¨è¯·æ±‚ç›‘æ§å‘½ä»¤
3. [ ] å¼¹å‡º MonitorCanvas å¹¶æ˜¾ç¤ºå®æ—¶æ•°æ®
4. [ ] ç­–ç•¥çŠ¶æ€å˜æ›´ååœ¨å¯¹è¯ä¸­æ˜¾ç¤ºåé¦ˆ
5. [ ] ä¸ AgentStore è”åŠ¨æ­£ç¡®
6. [ ] æš‚åœ/æ¢å¤/åœæ­¢æ“ä½œæ­£å¸¸å·¥ä½œ
7. [ ] TypeScript ç±»å‹å®‰å…¨æ£€æŸ¥é€šè¿‡

---

## Tasks / Subtasks

- [ ] **Task 1: ChatInterface çŠ¶æ€æ‰©å±•** (AC: 1, 2, 3)
  - [ ] æ·»åŠ  `monitorOpen` çŠ¶æ€
  - [ ] æ·»åŠ  `monitorAgentId` çŠ¶æ€
  - [ ] ä¿®æ”¹ `handleInsightAction` æ”¯æŒ `stop_agent`
  - [ ] æ¸²æŸ“ MonitorCanvas ç»„ä»¶

- [ ] **Task 2: useMonitor é›†æˆ** (AC: 3, 4)
  - [ ] åœ¨ ChatInterface ä¸­ä½¿ç”¨ useMonitor Hook
  - [ ] å®ç°ç­–ç•¥æ§åˆ¶å›è°ƒ
  - [ ] å®ç°çŠ¶æ€å˜æ›´é€šçŸ¥

- [ ] **Task 3: å¯¹è¯æ¶ˆæ¯åé¦ˆ** (AC: 4)
  - [ ] ç­–ç•¥æš‚åœåæ·»åŠ ç¡®è®¤æ¶ˆæ¯
  - [ ] ç­–ç•¥æ¢å¤åæ·»åŠ ç¡®è®¤æ¶ˆæ¯
  - [ ] ç­–ç•¥åœæ­¢åæ·»åŠ ç¡®è®¤æ¶ˆæ¯

- [ ] **Task 4: AgentStore è”åŠ¨** (AC: 5)
  - [ ] çŠ¶æ€å˜æ›´åŒæ­¥åˆ° AgentStore
  - [ ] ä» AgentStore è·å–è¿è¡Œä¸­ç­–ç•¥åˆ—è¡¨
  - [ ] éªŒè¯çŠ¶æ€ä¸€è‡´æ€§

- [ ] **Task 5: TypeScript æ£€æŸ¥** (AC: 7)
  - [ ] ä¿®å¤æ‰€æœ‰ç±»å‹é”™è¯¯
  - [ ] ç¡®ä¿ç»„ä»¶æ¥å£æ­£ç¡®

---

## Dev Notes

### ChatInterface é›†æˆæµç¨‹

```
1. AI è¿”å› InsightData with actions: ['stop_agent']
   æˆ–ç”¨æˆ·å‘é€ "ç›‘æ§ç­–ç•¥ xxx"
   â†“
2. handleInsightAction / è§£æç”¨æˆ·å‘½ä»¤
   â†“
3. æå– agentId (ä» insight.target æˆ–è§£æ)
   â†“
4. setMonitorOpen(true) + setMonitorAgentId(agentId)
   â†“
5. MonitorCanvas å¼¹å‡º
   â†“
6. useMonitor å¼€å§‹è½®è¯¢æ•°æ®
   â†“
7. ç”¨æˆ·æ“ä½œ (æš‚åœ/æ¢å¤/åœæ­¢)
   â†“
8. è°ƒç”¨ API â†’ æ›´æ–° AgentStore
   â†“
9. æ·»åŠ å¯¹è¯æ¶ˆæ¯åé¦ˆ
```

### ChatInterface çŠ¶æ€æ‰©å±•

```typescript
// ChatInterface.tsx æ–°å¢çŠ¶æ€

// ç›‘æ§çŠ¶æ€
const [monitorOpen, setMonitorOpen] = React.useState(false)
const [monitorAgentId, setMonitorAgentId] = React.useState<string>('')

// useMonitor Hook
const {
  state: monitorState,
  pauseAgent,
  resumeAgent,
  stopAgent,
} = useMonitor({
  agentId: monitorAgentId,
  enabled: monitorOpen,
  onStatusChange: handleMonitorStatusChange,
  onError: handleMonitorError,
})
```

### æ¶ˆæ¯åé¦ˆæ¨¡æ¿

```typescript
// ç­–ç•¥æš‚åœæ¶ˆæ¯
const pauseMessage = {
  role: 'assistant',
  content: `â¸ï¸ ç­–ç•¥ "${strategyName}" å·²æš‚åœè¿è¡Œã€‚

å½“å‰çŠ¶æ€ï¼š
- æŒä»“å·²ä¿ç•™ï¼Œä¸ä¼šè‡ªåŠ¨å¹³ä»“
- ç­–ç•¥ä¸ä¼šæ‰§è¡Œæ–°çš„äº¤æ˜“
- å¯éšæ—¶æ¢å¤è¿è¡Œ

éœ€è¦æ¢å¤è¿è¡Œå—ï¼Ÿ`,
}

// ç­–ç•¥åœæ­¢æ¶ˆæ¯
const stopMessage = {
  role: 'assistant',
  content: `ğŸ›‘ ç­–ç•¥ "${strategyName}" å·²åœæ­¢ã€‚

æœ€ç»ˆç»Ÿè®¡ï¼š
- æ€»ç›ˆäº: ${formatCurrency(pnl.total)}
- èƒœç‡: ${formatPercent(metrics.winRate)}
- æ€»äº¤æ˜“: ${metrics.totalTrades} æ¬¡

ç­–ç•¥å·²å®Œå…¨åœæ­¢ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²æ‰èƒ½å†æ¬¡è¿è¡Œã€‚`,
}
```

### æ–‡ä»¶è·¯å¾„

| æ–‡ä»¶ | è·¯å¾„ | æ“ä½œ |
|------|------|------|
| ChatInterface | `frontend/web-app/src/components/strategy/ChatInterface.tsx` | ä¿®æ”¹ |

---

## Dependencies

- Story 3.1: useMonitor Hook âœ…
- Story 3.2: ç›‘æ§ API æ¥å£ âœ…
- ç°æœ‰: `store/agent.ts` Agent çŠ¶æ€ç®¡ç†
- ç°æœ‰: `components/canvas/MonitorCanvas.tsx`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-25 | 1.0 | åˆå§‹ Story åˆ›å»º | YOLO Agent |

