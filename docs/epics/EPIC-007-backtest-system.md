# EPIC-007: 回测系统 (A2UI Canvas)

## 概述

实现基于 A2UI 的交互式回测系统，作为 Canvas 组件渲染，支持实时参数调节和结果预览。

## 用户旅程

```
Step 1: 说想法
用户输入："我觉得BTC跌太多了，想抄底"

        ↓

Step 2: AI理解 + 推荐角度
AI返回："抄底可以从几个角度判断：
        - RSI超卖（低于30）
        - 接近关键支撑位
        - 成交量放大
        你想用哪些？或者有其他想法？"

        ↓

Step 3: 用户选择/补充
用户："用RSI和支撑位吧"

        ↓

Step 4: 生成策略 + 回测
AI生成策略，显示：
        - 历史买卖点标注
        - 收益曲线
        - 胜率、盈亏比、最大回撤
        - 参数配置面板（A2UI）

        ↓

Step 5: 调参（可选）
用户拖动滑块调整参数
        - 实时看到回测结果变化
        - AI给微调建议

        ↓

Step 6: 运行策略
        - Paper Trading（默认）：零风险验证
        - 实盘：确认后切换
```

## 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                      Canvas 画布                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  BacktestInsight (A2UI 组件)                         │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  📈 K线图 + 买卖点标注                        │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  📊 收益曲线 (Equity Curve)                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │  ┌───────┬───────┬───────┬───────┐                  │   │
│  │  │胜率   │盈亏比  │最大回撤│交易次数│  ← 统计指标    │   │
│  │  │62.5%  │1.8:1  │-12.3% │48次   │                  │   │
│  │  └───────┴───────┴───────┴───────┘                  │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  🎛️ 参数面板 (A2UI Controls)                 │    │   │
│  │  │  RSI周期: ═══════●════  [14]                 │    │   │
│  │  │  超卖线: ═══●══════════  [30]                │    │   │
│  │  │  支撑位: [$41,200] [输入框]                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [🧪 Paper Trading]  [🚀 实盘运行]                          │
└─────────────────────────────────────────────────────────────┘
```

## Stories

### Story 7.1: BacktestInsight 数据类型
- 扩展 InsightType 加入 'backtest'
- 定义 BacktestTrade 交易记录结构
- 定义 BacktestStats 统计指标
- 定义 BacktestInsightData 完整结构

### Story 7.2: K线图 + 买卖点组件
- 基于 lightweight-charts 的 K线渲染
- 买入/卖出/平仓信号标注
- 支持缩放和时间范围选择
- 响应式设计

### Story 7.3: 收益曲线图组件
- Equity Curve 折线图
- 基准线对比 (Buy & Hold)
- 回撤区域着色
- Hover 显示详情

### Story 7.4: 统计指标卡片
- 核心指标网格展示
- 趋势指示器 (上涨/下跌)
- 与前值对比
- 颜色编码 (绿色正向/红色负向)

### Story 7.5: 参数调节面板
- Slider 滑块控件
- Number 输入框
- Select 下拉选择
- 参数联动约束
- 实时验证

### Story 7.6: Canvas 集成渲染
- BacktestCanvas 组件
- 参数变更触发回测
- 加载状态处理
- 错误边界

## 技术选型

| 功能 | 技术 |
|------|------|
| K线图 | lightweight-charts |
| 收益曲线 | recharts |
| 状态管理 | zustand |
| 参数控件 | 自定义 A2UI 组件 |

## 验收标准

- [ ] 回测结果在 Canvas 中正确渲染
- [ ] K线图显示买卖信号标注
- [ ] 收益曲线平滑渲染
- [ ] 统计指标实时更新
- [ ] 参数调节后回测结果刷新
- [ ] TypeScript 类型完整
- [ ] 生产构建通过

## 参考

- NoFx Backtest Lab 架构
- Delta Terminal A2UI 设计规范
- lightweight-charts 文档

---

**创建时间**: 2025-12-25
**状态**: 进行中
