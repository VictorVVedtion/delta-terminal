# Delta Terminal - 功能需求文档 (Feature Requirements)

> 版本：1.2 | 更新日期：2025-12-29 | 负责人：产品团队

---

## 文档说明

本文档详细描述 Delta Terminal 的功能需求，按照 Epic → Feature → User Story 的层级组织。

**优先级定义**：

- **P0**：MVP 必须，阻塞发布
- **P1**：高优先级，早期版本需要
- **P2**：中优先级，后续迭代
- **P3**：低优先级，可选增强

---

## Epic 1: AI 对话交易助手

**业务目标**：让用户通过自然语言对话创建和管理交易策略，降低使用门槛

**成功指标**：

- 策略创建成功率 ≥ 85%
- AI 对话满意度 ≥ 90%
- 平均策略创建时间 < 10 分钟

### Feature 1.1: 自然语言策略创建 (P0)

#### User Stories

**US-1.1.1: 用户可以用自然语言描述交易想法**

```
作为 新手用户
我想要 用日常语言描述我的交易想法
以便 不需要学习编程或复杂的配置界面
```

**验收标准**：

- ✅ 支持中文和英文输入
- ✅ 能理解常见交易术语："买入"、"卖出"、"止损"、"止盈"
- ✅ 能理解价格条件："当 BTC > 50000"、"跌破 40000"
- ✅ 能理解时间条件："每天 9 点"、"每周一"
- ✅ 能理解百分比："涨幅超过 5%"、"下跌 10%"
- ✅ 识别不明确的表述并主动询问澄清

**示例对话**：

```
用户："我想在比特币跌到 4 万美元的时候买 0.1 个"
AI："好的，我理解您的策略是：
     - 交易对：BTC/USDT
     - 触发条件：价格 ≤ 40000 USDT
     - 操作：市价买入 0.1 BTC

     请确认以下细节：
     1. 使用哪个交易所？（币安/OKX/Coinbase）
     2. 是否需要设置止损？
     3. 是否需要止盈？"
```

---

**US-1.1.2: AI 自动生成结构化策略配置**

```
作为 系统
我需要 将用户的自然语言转换为可执行的策略配置
以便 交易引擎能准确执行
```

**验收标准**：

- ✅ 生成标准化 JSON 策略配置
- ✅ 包含必填字段：交易对、交易所、触发条件、执行动作
- ✅ 自动填充合理默认值（如订单类型、滑点容忍）
- ✅ 标注不确定的字段，要求用户确认
- ✅ 生成可读的策略摘要供用户审核

**策略配置示例**：

```json
{
  "strategy_id": "uuid-xxx",
  "name": "BTC 40000 买入策略",
  "exchange": "binance",
  "symbol": "BTC/USDT",
  "triggers": [
    {
      "type": "price_condition",
      "operator": "<=",
      "value": 40000,
      "source": "last_price"
    }
  ],
  "actions": [
    {
      "type": "market_order",
      "side": "buy",
      "amount": 0.1,
      "amount_type": "base"
    }
  ],
  "risk_management": {
    "stop_loss": null,
    "take_profit": null,
    "max_position_size": 0.1
  },
  "status": "draft"
}
```

---

**US-1.1.3: 多轮对话优化策略**

```
作为 用户
我想要 通过持续对话调整策略参数
以便 精确表达我的交易意图
```

**验收标准**：

- ✅ AI 记住对话上下文（至少最近 10 轮）
- ✅ 支持增量修改："把买入量改成 0.2"
- ✅ 支持添加条件："再加一个止损 3 万 8"
- ✅ 支持删除条件："不要每天 9 点的限制"
- ✅ 每次修改后重新生成策略摘要
- ✅ 提供撤销/重做功能

---

### Feature 1.2: 策略智能分析与建议 (P1)

#### User Stories

**US-1.2.1: AI 评估策略风险**

```
作为 用户
我想要 AI 自动分析我策略的风险
以便 在执行前了解可能的损失
```

**验收标准**：

- ✅ 计算最大可能损失金额
- ✅ 评估风险等级（低/中/高）
- ✅ 识别常见风险：无止损、杠杆过高、仓位过大
- ✅ 提供风险缓解建议
- ✅ 对比历史类似策略表现

**风险报告示例**：

```
⚠️ 风险评估：中风险

最大可能损失：$4,000 (本金 100%)
主要风险点：
1. ❌ 未设置止损，可能导致无限亏损
2. ⚠️ 单次买入金额为总资金 80%，仓位过重
3. ✅ 价格触发条件明确

建议改进：
- 添加止损：价格跌破 38000 时卖出（限制损失 5%）
- 分批买入：分 3 次买入，降低单次风险
- 保留备用金：建议最多使用 60% 资金
```

---

**US-1.2.2: AI 主动提供优化建议**

```
作为 AI 助手
我应该 基于市场数据和历史表现主动优化策略
以便 提升策略成功率
```

**验收标准**：

- ✅ 分析当前市场状态（趋势、波动率）
- ✅ 建议更优的进场价格
- ✅ 建议合理的止损止盈位置
- ✅ 推荐适合的订单类型
- ✅ 用户可选择接受或忽略建议
- ✅ 说明建议理由（可解释 AI）

**建议示例**：

```
💡 优化建议

1. 进场价格调整
   当前：≤ 40000 USDT
   建议：≤ 39500 USDT
   理由：BTC 近期支撑位在 39500，此价格胜率提升 15%

2. 添加止盈
   建议：价格 ≥ 42000 USDT 时卖出
   理由：根据历史数据，从 40000 反弹至 42000 概率 68%

3. 订单类型优化
   当前：市价单
   建议：限价单 (39600 USDT)
   理由：节省滑点成本约 0.2%，节省 $80
```

---

### Feature 1.3: AI 市场洞察 (P2)

#### User Stories

**US-1.3.1: 实时市场解读**

```
作为 用户
我想要 AI 用通俗语言解释当前市场情况
以便 理解交易背景和时机
```

**验收标准**：

- ✅ 分析当前价格趋势（上涨/下跌/震荡）
- ✅ 计算关键技术指标（RSI、MACD、布林带）
- ✅ 识别支撑位和阻力位
- ✅ 分析市场情绪（恐惧/贪婪指数）
- ✅ 总结近期重要新闻事件
- ✅ 用简单语言表达，避免专业术语堆砌

---

**US-1.3.2: 智能交易信号**

```
作为 用户
我想要 AI 主动提醒我潜在的交易机会
以便 不错过好的入场时机
```

**验收标准**：

- ✅ 基于多个指标综合判断
- ✅ 提供买入/卖出/观望的明确建议
- ✅ 说明信号强度（强/中/弱）
- ✅ 注明信号有效期
- ✅ 支持推送通知（邮件、Telegram、App）
- ✅ 信号准确率 ≥ 60%（回测验证）

---

### Feature 1.4: Trading Spirit 人格系统 (P1)

#### User Stories

**US-1.4.1: 个性化 AI 人格**

```
作为 用户
我想要 为 AI 助手创建个性化人格
以便 获得更有情感连接的交互体验
```

**验收标准**：

- ✅ 用户可创建自定义 Spirit 人格
- ✅ 支持设置 Spirit 名称和描述
- ✅ Spirit 人格影响 AI 回复风格
- ✅ Spirit 数据通过 Supabase 持久化存储
- ✅ 引导向导帮助用户创建第一个 Spirit

---

**US-1.4.2: 反应式 Spirit Orb 可视化**

```
作为 用户
我想要 看到 AI 状态的视觉反馈
以便 知道 AI 正在处理我的请求
```

**验收标准**：

- ✅ SpiritOrb 组件显示 AI 当前状态
- ✅ 支持 4 种状态：idle (空闲)、thinking (思考中)、speaking (回应中)、error (错误)
- ✅ 使用 WebGL 着色器实现流畅动画效果
- ✅ 状态变化有平滑过渡动画
- ✅ 不同状态有不同的颜色和动效

**状态视觉设计**：

| 状态     | 颜色   | 动效     | 含义            |
| -------- | ------ | -------- | --------------- |
| idle     | 淡蓝色 | 轻微脉动 | AI 等待用户输入 |
| thinking | 蓝紫色 | 快速脉动 | AI 正在处理     |
| speaking | 青色   | 扩散光晕 | AI 正在回复     |
| error    | 红色   | 闪烁     | 处理出错        |

---

**US-1.4.3: 无状态上下文恢复**

```
作为 用户
我想要 在刷新页面或网络中断后恢复对话
以便 不丢失之前的对话上下文
```

**验收标准**：

- ✅ 前端维护完整的对话历史 (chatHistory)
- ✅ API 请求携带 chatHistory 作为 context 参数
- ✅ 后端从 chatHistory 重建对话上下文
- ✅ 多步骤引导流程中正确恢复已收集的参数
- ✅ 支持无 Redis 的无状态后端部署 (Railway)

---

## Epic 2: 交易所连接与管理

**业务目标**：安全、稳定地连接主流交易所，提供统一的账户管理

**成功指标**：

- 交易所 API 连接成功率 ≥ 99.5%
- 支持交易所数量 ≥ 5
- API 密钥泄露事故 = 0

### Feature 2.1: 交易所账户连接 (P0)

#### User Stories

**US-2.1.1: 安全的 API 密钥管理**

```
作为 用户
我想要 安全地连接我的交易所账户
以便 Delta Terminal 可以代我执行交易
```

**验收标准**：

- ✅ 支持主流交易所：币安、OKX、Coinbase、Kraken、Bitfinex
- ✅ 引导用户创建只读 + 交易权限的 API Key（禁止提现权限）
- ✅ API Key 加密存储（AES-256）
- ✅ 支持 IP 白名单绑定
- ✅ 定期（每 90 天）提醒用户轮换密钥
- ✅ 连接前测试 API 有效性

**安全要求**：

- 🔒 API Secret 仅存储加密哈希，永不明文显示
- 🔒 使用用户独立的加密密钥（基于用户密码衍生）
- 🔒 支持硬件安全模块 (HSM) 存储（企业版）
- 🔒 审计日志：记录所有 API 调用

---

**US-2.1.2: 多交易所统一管理**

```
作为 有多个交易所账户的用户
我想要 在一个界面查看和管理所有账户
以便 提高管理效率
```

**验收标准**：

- ✅ 聚合显示所有账户余额
- ✅ 统一的资产折算（USD/USDT）
- ✅ 支持账户别名（如 "币安-主账户"）
- ✅ 快速切换账户视图
- ✅ 标识账户状态（正常/异常/API 过期）
- ✅ 显示账户最后同步时间

---

### Feature 2.2: 实时账户数据同步 (P0)

#### User Stories

**US-2.2.1: 余额与持仓实时同步**

```
作为 用户
我想要 实时查看我的账户余额和持仓
以便 了解当前资金状态
```

**验收标准**：

- ✅ 每 5 秒同步一次余额（可配置）
- ✅ WebSocket 实时推送余额变动
- ✅ 显示可用余额和冻结余额
- ✅ 显示各币种持仓数量和价值
- ✅ 计算未实现盈亏
- ✅ 离线时缓存最后数据，上线自动同步

---

**US-2.2.2: 订单历史与交易记录**

```
作为 用户
我想要 查看我的历史订单和成交记录
以便 了解交易历史和策略表现
```

**验收标准**：

- ✅ 显示所有订单：待成交、部分成交、已成交、已取消
- ✅ 订单详情：时间、交易对、方向、价格、数量、手续费
- ✅ 支持筛选：按时间、交易对、状态、策略
- ✅ 导出为 CSV/Excel
- ✅ 成交记录与策略关联
- ✅ 计算每笔交易的盈亏

---

### Feature 2.3: 智能订单路由 (P2)

#### User Stories

**US-2.3.1: 自动选择最优交易所**

```
作为 用户
我想要 系统自动选择价格最优的交易所执行
以便 获得最佳成交价格
```

**验收标准**：

- ✅ 比较用户已连接交易所的实时价格
- ✅ 考虑深度、滑点、手续费
- ✅ 自动选择综合成本最低的交易所
- ✅ 显示预期节省金额
- ✅ 用户可手动指定交易所

---

### Feature 2.4: 模拟盘交易 (P0) 🆕

> **新增原因**：Party Mode 审查发现 MVP 缺少低风险验证环境，用户应能在零资金风险下验证策略

#### User Stories

**US-2.4.1: 模拟盘环境**

```
作为 新手用户
我想要 在模拟环境中测试我的策略
以便 在不承担真实资金风险的情况下验证策略效果
```

**验收标准**：

- ✅ 提供模拟盘账户，初始虚拟资金 $100,000 USDT
- ✅ 模拟盘使用真实市场价格数据
- ✅ 模拟盘策略执行逻辑与实盘完全一致
- ✅ 模拟盘支持所有策略类型（条件单、DCA、网格等）
- ✅ 模拟盘有明显的视觉标识（避免与实盘混淆）
- ✅ 用户可重置模拟盘账户

**模拟盘与实盘区别**：

| 特性     | 模拟盘           | 实盘           |
| -------- | ---------------- | -------------- |
| 资金来源 | 虚拟资金         | 真实交易所余额 |
| 订单执行 | 本地模拟撮合     | 真实交易所 API |
| 滑点模拟 | 基于历史数据估算 | 真实市场滑点   |
| 手续费   | 按真实费率扣除   | 真实扣除       |
| 风险     | 零风险           | 真实资金风险   |

---

**US-2.4.2: 模拟盘切换与对比**

```
作为 用户
我想要 方便地在模拟盘和实盘之间切换
以便 验证策略后快速部署到实盘
```

**验收标准**：

- ✅ 顶部导航栏显示当前模式（模拟盘/实盘）
- ✅ 一键切换模拟盘/实盘视图
- ✅ 切换时有确认提示（避免误操作）
- ✅ 模拟盘策略可一键"部署到实盘"
- ✅ 支持模拟盘与实盘策略表现对比

**界面示意**：

```
┌─────────────────────────────────────────────────┐
│  [🔵 模拟盘 ▼]  Delta Terminal                   │
│  ───────────────────────────────────────────    │
│  ⚠️ 当前为模拟环境，交易不使用真实资金            │
└─────────────────────────────────────────────────┘
```

---

## Epic 3: 策略创建与回测

**业务目标**：提供灵活的策略创建工具和专业的回测能力

**成功指标**：

- 策略类型覆盖 90% 用户需求
- 回测数据准确率 ≥ 95%
- 回测速度：1 年数据 < 5 秒

### Feature 3.1: 多样化策略类型 (P0-P2)

#### 策略类型清单

| 策略类型       | 优先级 | 描述                      | 适用场景           |
| -------------- | ------ | ------------------------- | ------------------ |
| **条件单**     | P0     | 价格/指标触发的一次性买卖 | 突破买入、止损止盈 |
| **定投 (DCA)** | P1     | 定时定额买入              | 长期看好某币种     |
| **网格交易**   | P1     | 在价格区间设置买卖网格    | 震荡市套利         |
| **追踪止损**   | P1     | 动态调整止损位            | 趋势跟踪           |
| **跨所套利**   | P2     | 利用交易所价差            | 低风险套利         |
| **三角套利**   | P3     | 利用三个币种价格差        | 高频套利           |
| **期现套利**   | P3     | 现货与合约对冲            | 对冲风险           |

---

#### User Stories

**US-3.1.1: 条件单策略 (P0)**

```
作为 用户
我想要 设置价格或指标条件触发的买卖单
以便 自动执行预定的交易计划
```

**验收标准**：

- ✅ 支持价格条件：>、<、=、>=、<=
- ✅ 支持技术指标：RSI、MACD、MA、BB、KDJ
- ✅ 支持组合条件：AND、OR 逻辑
- ✅ 支持时间条件：特定时间、周期性
- ✅ 支持交易量条件：24h 交易量变化
- ✅ 触发后可选择市价或限价单

**配置界面要素**：

```
[条件单策略配置]

触发条件：
□ 价格条件：BTC/USDT ≤ 40000
□ 指标条件：RSI(14) < 30 (超卖)
□ 时间条件：工作日 9:00-17:00
□ 逻辑：全部满足 (AND) / 任一满足 (OR)

执行动作：
- 交易方向：买入 ○ / 卖出 ○
- 订单类型：市价单 ○ / 限价单 ○
- 买入数量：0.1 BTC / 按金额 $4000
- 有效期：触发后立即执行 / 触发后 5 分钟内有效

后续动作（可选）：
□ 止损：价格 ≤ 38000
□ 止盈：价格 ≥ 42000
□ 执行后暂停策略 / 重新启用策略
```

---

**US-3.1.2: 定投 (DCA) 策略 (P1)**

```
作为 长期投资用户
我想要 设置定时定额买入
以便 平滑成本，降低择时风险
```

**验收标准**：

- ✅ 支持周期：每小时、每日、每周、每月
- ✅ 支持固定金额或固定数量
- ✅ 支持跳过高点：价格超过阈值时暂停买入
- ✅ 支持智能加仓：价格下跌时加倍买入
- ✅ 显示预计执行时间
- ✅ 可设置总投资上限

**示例配置**：

```
定投策略：每周买入 BTC

基础设置：
- 执行时间：每周一 10:00
- 买入金额：$500
- 买入方式：市价单
- 总预算：$26,000 (1 年)

智能优化：
☑ 启用跳过高点：价格 > 50000 时暂停
☑ 启用智能加仓：价格下跌 > 10% 时买入双倍
☐ 启用动态金额：根据 RSI 调整买入金额
```

---

**US-3.1.3: 网格交易策略 (P1)**

```
作为 震荡市交易者
我想要 在价格区间内设置多个买卖网格
以便 自动高抛低吸赚取差价
```

**验收标准**：

- ✅ 设置价格区间（上限、下限）
- ✅ 设置网格数量（3-100 个）
- ✅ 自动计算每格间距和数量
- ✅ 支持等差网格和等比网格
- ✅ 显示预期收益率
- ✅ 突破区间时可选择：止损/跟随/暂停

**网格计算示例**：

```
网格交易计算器

价格区间：30000 - 50000 USDT
网格数量：10 格
网格类型：等差网格

计算结果：
- 每格间距：2000 USDT
- 买入网格：30000, 32000, 34000, 36000, 38000
- 卖出网格：42000, 44000, 46000, 48000, 50000
- 单格投资：$1000
- 总投资：$10,000
- 预期收益率：每完成一轮 4-6%

风险提示：
⚠️ 如价格跌破 30000，将继续买入并扩大亏损
⚠️ 如价格突破 50000，将失去进一步上涨收益
```

---

### Feature 3.2: 专业回测引擎 (P0-P2)

#### User Stories

**US-3.2.1: 历史数据回测 (P0)**

```
作为 用户
我想要 用历史数据测试我的策略
以便 评估策略的有效性
```

**验收标准**：

- ✅ 支持时间范围选择（最长 5 年）
- ✅ 支持多个时间粒度：1m、5m、15m、1h、4h、1d
- ✅ 模拟真实市场：考虑滑点、手续费、市场深度
- ✅ 回测速度：1 年 1 小时数据 < 5 秒
- ✅ 显示详细回测报告
- ✅ 可视化回测过程（价格图 + 买卖点标记）

**回测报告内容**：

```
回测报告：BTC 40000 买入策略
回测时间：2024-01-01 至 2024-12-31

📊 绩效指标
总收益率：+23.5%
年化收益率：+23.5%
最大回撤：-15.2%
夏普比率：1.82
索提诺比率：2.41
盈亏比：2.3:1

📈 交易统计
总交易次数：47 次
盈利次数：32 次 (68.1%)
亏损次数：15 次 (31.9%)
平均盈利：+$450
平均亏损：-$195
最大单笔盈利：+$1,250
最大单笔亏损：-$480

💰 资金曲线
初始资金：$10,000
最终资金：$12,350
最高资金：$12,980 (2024-11-05)
最低资金：$8,480 (2024-08-12)

⏱️ 时间分析
平均持仓时间：3.2 天
最长持仓：15 天
最短持仓：6 小时

💵 成本分析
总手续费：$284
滑点损失：~$120
净收益：$2,350 - $404 = $1,946
```

---

**US-3.2.2: 参数优化 (P2)**

```
作为 高级用户
我想要 自动测试不同参数组合
以便 找到最优策略参数
```

**验收标准**：

- ✅ 支持多参数网格搜索
- ✅ 支持遗传算法优化
- ✅ 可设置优化目标（收益率/夏普比率/最大回撤）
- ✅ 显示参数热力图
- ✅ 防止过拟合：提供训练集/测试集分割
- ✅ 优化时间：100 种参数组合 < 1 分钟

---

**US-3.2.3: 策略对比**

```
作为 用户
我想要 同时对比多个策略的表现
以便 选择最优策略
```

**验收标准**：

- ✅ 同时回测最多 5 个策略
- ✅ 并排显示关键指标
- ✅ 叠加资金曲线图
- ✅ 高亮最优策略
- ✅ 导出对比报告

---

### Feature 3.3: 策略生命周期管理 (P0) 🆕

> **新增原因**：Party Mode 审查发现缺少策略删除功能，用户无法清理历史策略

#### User Stories

**US-3.3.1: 策略删除**

```
作为 用户
我想要 删除不再需要的策略
以便 保持策略列表整洁，避免混淆
```

**验收标准**：

- ✅ 策略详情页和列表页都提供删除入口
- ✅ 删除前显示确认对话框，说明影响
- ✅ 运行中的策略不能直接删除（需先停止）
- ✅ 软删除机制：删除后进入"回收站"，保留 30 天
- ✅ 回收站内策略可恢复
- ✅ 30 天后自动永久删除
- ✅ 删除时保留交易历史记录（用于审计）

**删除确认对话框**：

```
┌─────────────────────────────────────────────────┐
│  ⚠️ 确认删除策略                                 │
│                                                  │
│  您确定要删除策略 "BTC 40000 买入" 吗？           │
│                                                  │
│  • 策略将移入回收站，保留 30 天                   │
│  • 30 天内可在回收站恢复                         │
│  • 相关交易记录将保留                            │
│                                                  │
│  ┌────────────┐  ┌────────────┐                 │
│  │    取消    │  │  确认删除  │                 │
│  └────────────┘  └────────────┘                 │
└─────────────────────────────────────────────────┘
```

---

**US-3.3.2: 策略归档**

```
作为 长期用户
我想要 归档暂时不用但不想删除的策略
以便 保持活跃策略列表简洁
```

**验收标准**：

- ✅ 支持策略归档操作
- ✅ 归档策略从主列表隐藏
- ✅ 提供"已归档"标签页查看归档策略
- ✅ 归档策略可随时恢复到主列表
- ✅ 归档策略不计入活跃策略数量限制

---

**US-3.3.3: 策略版本历史**

```
作为 用户
我想要 查看策略的修改历史
以便 了解策略演变过程，必要时回退到历史版本
```

**验收标准**：

- ✅ 记录每次策略参数修改
- ✅ 显示修改时间、修改内容、修改人
- ✅ 支持对比两个版本的差异
- ✅ 支持回退到历史版本
- ✅ 版本历史保留最近 50 个版本

---

## Epic 4: 风险管理系统

**业务目标**：保护用户资金安全，降低交易风险

**成功指标**：

- 启用风控的策略亏损 < 未启用的 50%
- 风控触发准确率 ≥ 95%
- 爆仓事件 = 0

### Feature 4.1: 智能止损止盈 (P0)

#### User Stories

**US-4.1.1: 固定止损止盈**

```
作为 用户
我想要 为每个策略设置止损和止盈
以便 控制单次交易的风险和收益
```

**验收标准**：

- ✅ 支持绝对价格止损："BTC ≤ 38000 时卖出"
- ✅ 支持百分比止损："亏损 5% 时卖出"
- ✅ 支持绝对价格止盈："BTC ≥ 45000 时卖出"
- ✅ 支持百分比止盈："盈利 15% 时卖出"
- ✅ 支持同时设置止损和止盈
- ✅ 触发时立即执行市价单
- ✅ AI 推荐合理止损止盈位（基于波动率）

---

**US-4.1.2: 追踪止损**

```
作为 趋势跟踪用户
我想要 止损位随价格上涨而上移
以便 保护利润的同时继续跟踪趋势
```

**验收标准**：

- ✅ 设置追踪距离（绝对值或百分比）
- ✅ 价格上涨时自动提升止损位
- ✅ 价格下跌时止损位不下移
- ✅ 可视化显示当前止损位
- ✅ 实时更新止损位变化日志

**示例**：

```
追踪止损设置

买入价格：40000 USDT
追踪距离：5% (2000 USDT)
当前价格：43000 USDT
当前止损：40850 USDT (43000 - 5%)

价格变动记录：
- 40000 → 41000：止损提升至 38950
- 41000 → 42000：止损提升至 39900
- 42000 → 43000：止损提升至 40850
- 43000 → 42500：止损保持 40850 (不下移)
```

---

### Feature 4.2: 仓位与资金管理 (P0)

#### User Stories

**US-4.2.1: 仓位限制**

```
作为 谨慎的用户
我想要 限制单个策略的最大仓位
以便 避免重仓导致的巨大风险
```

**验收标准**：

- ✅ 设置单策略最大仓位比例（如 20%）
- ✅ 设置单币种最大持仓比例
- ✅ 设置总仓位上限
- ✅ 超过限制时拒绝开仓
- ✅ 仓位使用情况可视化（仪表盘）
- ✅ AI 建议合理仓位配置

**示例配置**：

```
仓位管理规则

总资金：$50,000

限制规则：
- 单策略最大仓位：20% ($10,000)
- 单币种最大持仓：30% ($15,000)
- 总仓位上限：80% ($40,000)
- 保留备用金：20% ($10,000)

当前仓位使用：
BTC：$8,000 (16%) ✅
ETH：$5,000 (10%) ✅
总仓位：$13,000 (26%) ✅
可用资金：$37,000
```

---

**US-4.2.2: 交易限额**

```
作为 用户
我想要 设置每日/每月交易额度上限
以便 避免过度交易
```

**验收标准**：

- ✅ 设置单日最大交易额
- ✅ 设置单月最大交易额
- ✅ 设置单日最大交易次数
- ✅ 超过限额时暂停交易
- ✅ 次日/次月自动重置
- ✅ 额度使用情况实时显示

---

### Feature 4.3: 异常监测与熔断 (P1)

#### User Stories

**US-4.3.1: 市场异常监测**

```
作为 系统
我应该 监测市场异常波动
以便 及时保护用户资金
```

**验收标准**：

- ✅ 监测短期剧烈波动（如 5 分钟 ±10%）
- ✅ 监测交易量异常（暴涨/骤降）
- ✅ 监测交易所 API 延迟/失败
- ✅ 监测可疑的市场操纵（如拉盘砸盘）
- ✅ 异常时自动暂停所有策略
- ✅ 推送紧急通知给用户

---

**US-4.3.2: 策略熔断机制**

```
作为 用户
我想要 设置策略的熔断条件
以便 亏损达到一定程度时自动停止
```

**验收标准**：

- ✅ 设置单日最大亏损额
- ✅ 设置总亏损额熔断
- ✅ 设置连续亏损次数熔断
- ✅ 触发熔断时自动平仓/暂停
- ✅ 熔断后需手动重新启用
- ✅ 记录熔断事件日志

**示例**：

```
熔断规则

策略：网格交易 BTC

熔断条件：
☑ 单日亏损 ≥ $500 → 暂停策略
☑ 总亏损 ≥ $2,000 → 平仓并停止
☑ 连续亏损 ≥ 5 次 → 暂停策略
☐ 回撤 ≥ 20% → 平仓并停止

熔断历史：
- 2024-12-20 14:32：触发单日亏损熔断 ($520)，已暂停
- 2024-11-15 09:15：触发连续亏损熔断 (5 次)，已暂停
```

---

## Epic 5: 仪表盘与数据可视化

**业务目标**：提供清晰直观的数据展示，帮助用户监控和决策

**成功指标**：

- 页面加载时间 < 2 秒
- 数据刷新延迟 < 1 秒
- 用户对 UI 满意度 ≥ 4.5/5

### Feature 5.1: 总览仪表盘 (P0)

#### User Stories

**US-5.1.1: 资产总览**

```
作为 用户
我想要 在首页看到我的资产总览
以便 快速了解账户状态
```

**验收标准**：

- ✅ 显示总资产价值（USD/USDT）
- ✅ 显示今日盈亏（金额 + 百分比）
- ✅ 显示总盈亏（自开始使用）
- ✅ 资产分布饼图（各币种占比）
- ✅ 资产趋势折线图（7 天/30 天/全部）
- ✅ 跨交易所资产汇总

**界面示意**：

```
┌─────────────────────────────────────┐
│ 💰 总资产价值                         │
│ $52,350.80 USDT                    │
│ ↑ +$1,250.30 (+2.45%) 今日         │
│ ↑ +$12,350.80 (+30.88%) 总计       │
└─────────────────────────────────────┘

┌──────────────┬──────────────────────┐
│ 资产分布       │  资产趋势 (30天)       │
│              │                       │
│  [饼图]       │  [折线图]             │
│              │                       │
└──────────────┴──────────────────────┘
```

---

**US-5.1.2: 策略状态监控**

```
作为 用户
我想要 看到所有运行中策略的状态
以便 快速发现问题
```

**验收标准**：

- ✅ 显示策略列表（名称、状态、盈亏）
- ✅ 状态标识：运行中/已暂停/已停止/错误
- ✅ 显示每个策略的关键指标
- ✅ 支持快速启动/暂停策略
- ✅ 异常策略高亮显示
- ✅ 支持按状态/盈亏/创建时间排序

---

### Feature 5.2: 策略详情页 (P0)

#### User Stories

**US-5.2.1: 策略性能分析**

```
作为 用户
我想要 查看单个策略的详细表现
以便 评估和优化策略
```

**验收标准**：

- ✅ 显示策略配置详情
- ✅ 显示实时盈亏和收益率
- ✅ 显示所有交易记录
- ✅ 显示资金曲线图
- ✅ 显示关键绩效指标
- ✅ 与回测结果对比（预期 vs 实际）

---

**US-5.2.2: 交易日志**

```
作为 用户
我想要 看到策略的所有交易日志
以便 了解策略执行细节和排查问题
```

**验收标准**：

- ✅ 时间线展示所有事件
- ✅ 记录触发条件满足时间
- ✅ 记录订单提交/成交/失败
- ✅ 记录风控触发事件
- ✅ 记录错误和重试
- ✅ 支持按时间/事件类型筛选
- ✅ 导出日志文件

---

### Feature 5.3: 高级图表 (P1)

#### User Stories

**US-5.3.1: 交互式K线图**

```
作为 技术分析用户
我想要 查看带有策略标记的 K 线图
以便 直观理解策略执行时机
```

**验收标准**：

- ✅ 集成 TradingView 图表
- ✅ 标记买入/卖出点
- ✅ 显示止损止盈线
- ✅ 叠加技术指标
- ✅ 支持多时间周期切换
- ✅ 支持绘图工具（趋势线、斐波那契等）

---

**US-5.3.2: 策略对比看板**

```
作为 运行多个策略的用户
我想要 并排对比策略表现
以便 资源优化配置
```

**验收标准**：

- ✅ 同时显示最多 4 个策略
- ✅ 对齐时间轴对比资金曲线
- ✅ 并排显示关键指标
- ✅ 高亮最优/最差策略
- ✅ 支持自定义指标显示

---

## 功能优先级矩阵

### MVP (前 3 个月) - P0 聚焦

```
核心功能 (P0 必须)
├─ AI 对话式策略创建
├─ 币安交易所连接
├─ 条件单策略
├─ 基础回测 (历史数据回测)
├─ 固定止损止盈
├─ 仓位限制
├─ 总览仪表盘
├─ 🆕 模拟盘交易 (零风险验证)
└─ 🆕 策略删除与管理

⚠️ 已从 MVP 移出:
├─ 定投 (DCA) → P1
└─ 参数优化回测 → P2
```

### Post-MVP (3-6 个月) - P1 增强

```
中等价值
├─ 定投 (DCA) 策略 ← 从MVP移入
├─ 网格交易策略
├─ 智能风险评估
├─ 多交易所支持 (OKX, Coinbase)
├─ 追踪止损
├─ 交易限额
├─ 异常监测熔断
├─ 策略性能分析
├─ AI 市场洞察
└─ 交互式K线图
```

### 未来迭代 (6-12 个月) - P2/P3

```
增强功能
├─ 参数优化回测 ← 从规划移入
├─ 跨所套利
├─ 智能订单路由
├─ 策略模板市场
├─ 社交跟单
├─ 移动端 App
└─ 开放 API
```

---

## 技术依赖与接口

### 外部服务依赖

| 服务            | 用途                     | 备选方案          |
| --------------- | ------------------------ | ----------------- |
| **Claude API**  | AI 对话和策略生成        | OpenAI GPT-4      |
| **交易所 API**  | 交易执行和数据获取       | 无备选            |
| **TradingView** | 图表显示                 | LightweightCharts |
| **Pinecone**    | 向量数据库（策略相似度） | Weaviate          |
| **SendGrid**    | 邮件通知                 | AWS SES           |

### 关键技术选型

- **前端**：Next.js 15, React 19, TypeScript, TailwindCSS
- **状态管理**：Zustand / Jotai
- **图表**：Recharts, TradingView Widgets
- **实时通信**：Socket.IO / WebSocket
- **后端**：Node.js (Fastify) / Python (FastAPI)
- **数据库**：PostgreSQL (主库), Redis (缓存), TimescaleDB (时序)
- **消息队列**：BullMQ (基于 Redis)

---

**文档版本历史**

| 版本 | 日期       | 修改内容                                                                                                                                                                   | 作者         |
| ---- | ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ |
| 1.0  | 2025-12-24 | 初始版本，完整功能需求                                                                                                                                                     | Product Team |
| 1.1  | 2025-12-28 | 新增 Feature 1.4 Trading Spirit 人格系统 (US-1.4.1/1.4.2/1.4.3)                                                                                                            | Claude       |
| 1.2  | 2025-12-29 | **Party Mode 审查迭代**：<br>• MVP 范围裁剪：DCA→P1, 参数优化→P2<br>• 新增 Feature 2.4 模拟盘交易 (P0)<br>• 新增 Feature 3.3 策略生命周期管理 (P0)<br>• 更新功能优先级矩阵 | PM John      |
